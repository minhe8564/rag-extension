# **HEBEES Frontend 포팅(배포) 매뉴얼 v1.0**

> 대상: 운영/개발 환경에 프론트엔드(React + Vite, TypeScript) 서비스를 설치·구동·운영하려는 엔지니어

---

## **1) 시스템 개요**

- **Framework**: React 18.3.1
- **Build Tool**: Vite 7.1.7
- **Language**: TypeScript 5.9.3
- **Package Manager**: pnpm
- **Web Server**: Nginx (Alpine)
- **State Management**: Zustand 5.0.8
- **HTTP Client**: Axios 1.12.2
- **Data Fetching**: TanStack Query 5.90.5
- **Routing**: React Router DOM 7.9.4
- **UI**: Tailwind CSS 3.4.14, Lucide React
- **SSE**: EventSource Polyfill (Server-Sent Events)
- **Deployment**: Docker + Nginx

## **2) 소스 구조 & 빌드 스펙**

- **Node.js**: 22.10.0 (필수)
- **pnpm**: 최신 버전 (자동 설치)
- **빌드 모드**:
- development: develop 브랜치
- production: main 브랜치 (기본값)

> package.json과 pnpm-lock.yaml의 버전을 동일하게 유지하세요. Node.js 22 미만에서는 빌드가 실패할 수 있습니다.

## **3) 환경 변수(ENV) 정의**

> Vite는 .env.development 또는 .env.production 파일을 자동으로 읽습니다. 모든 환경 변수는 VITE_ 접두사가 필요합니다.

**3.1 ENV**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| VITE_ENV | 빌드 모드 | production |
| VITE_SPRING_BASE_URL | Spring Base URL | [https://spring.ragextension.shop](https://spring.ragextension.shop/) |
| VITE_GATEWAY_BASE_URL | FastAPI Gateway URL | [https://gateway.ragextension.shop](https://gateway.ragextension.shop/) |
| VITE_RAG_BASE_URL | FastAPI RAG Gateway URL | https://gateway.ragextension.shop/rag |
| VITE_FASTAPI_BASE_URL | FastAPI Backend URL | https://gateway.ragextension.shop/be |

## **4) 로컬 개발 절차**

**4.1 사전 준비물**

- Node.js 22.x, pnpm

**4.2 환경 변수 파일 생성**

프로젝트 루트에 .env.development 파일 생성:

```jsx
VITE_ENV=development

VITE_SPRING_BASE_URL=https://dev-spring.ragextension.shop
VITE_GATEWAY_BASE_URL=https://gateway.ragextension.shop
VITE_RAG_BASE_URL=https://gateway.ragextension.shop/rag
VITE_FASTAPI_BASE_URL=https://gateway.ragextension.shop/be
```

**4.3 의존성 설치 & 실행**

```jsx
# pnpm 설치 (없는 경우)
npm install -g pnpm

# 의존성 설치
pnpm install

# 개발 서버 실행
pnpm dev

# 빌드
pnpm build

# 빌드 결과 미리보기
pnpm preview
```

## **5) 배포 절차**

**5.1 배포 전략**

프로젝트는 브랜치 기반 배포를 사용합니다:

- **Test 환경**: develop 브랜치 → rag-extension-fe-test (포트: 17443)
- **Prod 환경**: main 브랜치 → rag-extension-fe-prod (포트: 7443)

**5.2 배포 단계**

1. 환경 변수 파일 준비 (.env.development 또는 .env.production)
2. Docker 이미지 빌드: docker build -t rag-extension/frontend-app:${ENV}-${BUILD_NUMBER} --build-arg MODE=${MODE} .
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행

**5.3 Docker 실행 명령어**

```jsx
docker run -d \
  --name ${DOCKER_CONTAINER_NAME} \
  --network ${NETWORK_NAME} \
  --restart unless-stopped \
  --publish ${HOST_PORT}:80 \
  ${IMAGE_NAME}:${IMAGE_TAG}
```

# **HEBEES Backend(Spring) 포팅(배포) 매뉴얼 v1.0**

> 대상: 운영/개발 환경에 백엔드(Spring Boot 3.5.6, Java 21) 서비스를 설치·구동·운영하려는 엔지니어

---

## **1) 시스템 개요**

- **Framework**: Spring Boot 3.5.6 (Java 21)
- **Build**: Gradle (wrapper 포함)
- **DB**: MySQL (mysql-connector-j), MongoDB, JPA + Querydsl
- **Cache**: Redis (Lettuce)
- **Auth**: JWT (jjwt 0.11.5)
- **Web**: Spring MVC + WebFlux (SSE 스트리밍), Validation
- **Docs**: springdoc-openapi (Swagger UI)
- **LLM**: OpenAI, Runpod 지원
- **Monitoring**: cAdvisor 연동, OSHI (시스템 자원 모니터링)
- **Deployment**: Blue/Green 배포 전략

## **2) 환경 변수(ENV)**

**2.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| SERVER_PORT | Spring Boot 포트 | 8080 |
| SPRING_PROFILES_ACTIVE | 활성 프로파일 | docker (운영), local (로컬) |

**2.2 MySQL**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_NAME | 데이터베이스 이름 | hebees-test |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

**2.3 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_PASSWORD | 비밀번호 | 1q2w3e4r |

**2.4 MongoDB**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MONGODB_DATABASE | MongoDB 데이터베이스 | hebees |
| MONGODB_USERNAME | MongoDB 계정 | s407 |
| MONGODB_PASSWORD | MongoDB 비밀번호 | 1q2w3e4r |

**2.5 보안/인증**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| JWT_SECRET | JWT 서명 키 | hebees-secret-key-for-jwt-token-generation-and-validation-256-bits |
| JWT_ACCESS_TOKEN_EXPIRATION | Access Token 만료 시간(ms) | 3600000 (1시간) |
| JWT_REFRESH_TOKEN_EXPIRATION | Refresh Token 만료 시간(ms) | 1209600000 (14일) |

**2.6 LLM API**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| OPENAI_API_KEY | OpenAI API Key | sk-... |

**2.7 Runpod**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| RUNPOD_API_KEY | Runpod API Key (모니터링용) | rpa_... |

**2.8 모니터링**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| monitoring.cadvisor.base-url | cAdvisor URL | http://cadvisor:8080 (Docker) |
| monitoring.service-targets | 모니터링 대상 서비스 목록 | YAML 리스트 (예: chunking-repo=hebees-chunking) |

## **3) 배포 절차**

**3.1 Blue/Green 배포 전략**

프로젝트는 Blue/Green 배포 전략을 사용합니다:

- **Test 환경**: develop 브랜치 → rag-extension-be-test-blue/green
- **Prod 환경**: main 브랜치 → rag-extension-be-prod-blue/green

**3.2 배포 단계**

1. Docker 이미지 빌드: docker build -t rag-extension/backend-app:${ENV}-${BUILD_NUMBER} .
2. 비활성 환경에 컨테이너 배포
3. Health Check: /api/v1/actuator/health
4. Nginx upstream 전환
5. 기존 컨테이너 중지

```jsx
docker run -d \
  --name ${DOCKER_CONTAINER_NAME} \
  --network ${NETWORK_NAME} \
  --network ${DB_NETWORK} \
  --network-alias backend-${ENV} \
  --restart unless-stopped \
  -v /var/run/docker.sock:/var/run/docker.sock \
  --env SPRING_PROFILES_ACTIVE=docker \
  --env DB_USERNAME=${DB_USERNAME} \
  --env DB_PASSWORD=${DB_PASSWORD} \
  --env DB_NAME=${DB_NAME} \
  --env REDIS_PASSWORD=${REDIS_PASSWORD} \
  --env MONGODB_DATABASE=${MONGODB_DATABASE} \
  --env MONGODB_USERNAME=${MONGODB_USERNAME} \
  --env MONGODB_PASSWORD=${MONGODB_PASSWORD} \
  --env JWT_SECRET=${JWT_SECRET} \
  --env JWT_ACCESS_TOKEN_EXPIRATION=${JWT_ACCESS_TOKEN_EXPIRATION} \
  --env JWT_REFRESH_TOKEN_EXPIRATION=${JWT_REFRESH_TOKEN_EXPIRATION} \
  --env RUNPOD_API_KEY=${RUNPOD_API_KEY} \
  ${IMAGE_NAME}:${IMAGE_TAG}
```

# **HEBEES FastAPI Gateway 포팅(배포) 매뉴얼 v1.0**

> 대상: 운영/개발 환경에 FastAPI Gateway 서비스를 설치·구동·운영하려는 엔지니어

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **HTTP Client**: HTTPX 0.28.1 (프록시용)
- **Auth**: JWT (PyJWT 2.8.0)
- **Docs**: FastAPI 자체 Swagger UI + 서비스별 문서 프록시
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv (자동 설치)
- **의존성 관리**: pyproject.toml + uv.lock

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.

**3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서버 이름 | HEBEES API Gateway |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

**3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,https://www.ragextension.shop,*.beta9.kr |

> 와일드카드 도메인 지원: *.beta9.kr 형식은 정규식으로 자동 변환됩니다.

**3.3 JWT 인증**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| JWT_SECRET | JWT 서명 키(충분히 긴 랜덤) | hebees-secret-key-for-jwt-token-generation-and-validation-256-bits |
| JWT_ALGORITHM | JWT 알고리즘 | HS512 |
| JWT_ACCESS_TOKEN_EXPIRE_MINUTES | Access Token 만료 시간(분) | 30 |
| JWT_REFRESH_TOKEN_EXPIRE_DAYS | Refresh Token 만료 시간(일) | 7 |

> JWT_SECRET은 Spring Boot 백엔드와 동일한 값이어야 합니다.

**3.4 프록시 대상 서비스**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| RAG_ORCHESTRATOR_URL | RAG Orchestrator URL | http://hebees-rag-orchestrator:8000 |
| PYTHON_BACKEND_URL | Python Backend URL | http://hebees-python-backend:8000 |

> Docker 네트워크 내부에서는 서비스명으로 접근합니다.

**3.5 Database (MySQL)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_HOST | MySQL 호스트 | database-mysql |
| DB_PORT | MySQL 포트 | 3306 |
| DB_NAME | 데이터베이스 이름 | hebees-test |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

**3.6 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/fastapi-gateway.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

## **4) 로컬 개발 절차**

**4.1 사전 준비물**

- Python 3.11+, uv, MySQL 8.x

**4.2 환경 변수 주입(.env 예시)**

```jsx
# 애플리케이션 설정
APP_NAME=HEBEES API Gateway
HOST=0.0.0.0
PORT=8000

ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://www.ragextension.shop,https://dev.ragextension.shop,http://localhost:7700,https://starlits.beta9.kr,*.beta9.kr

# JWT 설정
JWT_SECRET=hebees-secret-key-for-jwt-token-generation-and-validation-256-bits
JWT_ALGORITHM=HS512
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7

# RunPod 설정
RUNPOD_API_KEY=your_runpod_api_key_here

# 데이터베이스 설정
DB_HOST=database-mysql
DB_PORT=13306
DB_NAME=hebees-test
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4

# 로깅
LOGGING_LEVEL=INFO
RAG_ORCHESTRATOR_URL=http://hebees-rag-orchestrator:8000
PYTHON_BACKEND_URL=http://hebees-python-backend:8000
```

**4.3 의존성 설치 & 실행**

```jsx
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh

# 의존성 설치
uv sync --frozen --no-dev

# 개발 서버 실행
python run.py

# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**4.4 API 문서 접근**

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- 서비스별 문서:
    - RAG Orchestrator: http://localhost:8000/service-docs/rag/docs
    - Python Backend: http://localhost:8000/service-docs/be/docs

## **5) 배포 절차**

**5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: rag-extension-gw
- **네트워크**: app-network-test, app-network-prod, db-network

**5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials)
2. Docker 이미지 빌드: docker build -t rag-extension/fastapi-gateway:${BUILD_NUMBER} .
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행 (환경 변수 주입)
5. Health Check: /health 엔드포인트 확인

**5.3 Docker 실행 명령어**

```jsx
docker run -d \
  --name rag-extension-gw \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --network db-network \
  --env-file .env \
  rag-extension/fastapi-gateway:${BUILD_NUMBER}
```

> **중요**: 여러 네트워크에 연결하여 다른 서비스들과 통신할 수 있도록 합니다.

## **6) API 라우팅 구조**

**6.1 주요 엔드포인트**

- /health - 헬스체크
- /docs - FastAPI Swagger UI
- /redoc - ReDoc 문서
- /openapi.json - OpenAPI 스키마

**6.2 프록시 라우팅**

- /rag/* → RAG_ORCHESTRATOR_URL/*
- 예: POST /rag/query/process → http://hebees-rag-orchestrator:8000/query/process
- /be/* → PYTHON_BACKEND_URL/*
- 예: POST /be/api/v1/sales-reports/chain-summary → http://hebees-python-backend:8000/api/v1/sales-reports/chain-summary

**6.3 서비스별 문서**

- /service-docs/rag/docs - RAG Orchestrator Swagger UI
- /service-docs/be/docs - Python Backend Swagger UI

# **HEBEES RAG Orchestrator 포팅(배포) 매뉴얼 v1.0**

> 대상: 운영/개발 환경에 RAG Orchestrator 서비스(FastAPI)를 설치·구동·운영하려는 엔지니어

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **Vector DB**: Milvus
- **Cache**: Redis
- **HTTP Client**: HTTPX 0.28.1 (서비스 간 통신)
- **Docs**: FastAPI 자체 Swagger UI
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv
- **의존성 관리**: pyproject.toml + uv.lock

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.

## **3) 환경 변수(ENV)**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.

**3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서버 이름 | HEBEES RAG Orchestrator Service |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

**3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | [http://localhost:5173](http://localhost:5173/),[http://localhost:3000](http://localhost:3000/),[https://dev.ragextension.shop](https://dev.ragextension.shop/),[https://www.ragextension.shop](https://www.ragextension.shop/) |

**3.3 MySQL**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_HOST | MySQL 호스트 | database-mysql |
| DB_PORT | MySQL 포트 | 3306 |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

**3.4 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_HOST | Redis 호스트 | database-redis |
| REDIS_PORT | Redis 포트 | 6379 |
| REDIS_USERNAME | Redis 계정 | default |
| REDIS_PASSWORD | Redis 비밀번호 | 1q2w3e4r |
| REDIS_DB | Redis DB 인덱스 | 1 |

**3.5 Milvus (Vector Database)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MILVUS_HOST | Milvus 호스트 | milvus-standalone |
| MILVUS_PORT | Milvus 포트 | 19530 |

**3.5 외부 서비스 URL (서비스 간 직접 통신)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| GATEWAY_URL | FastAPI Gateway URL | http://rag-extension-gw:8000 |
| EXTRACT_SERVICE_URL | Extract 서비스 URL | http://hebees-extract:8000 |
| CHUNKING_SERVICE_URL | Chunking 서비스 URL | http://hebees-chunking:8000 |
| EMBEDDING_SERVICE_URL | Embedding 서비스 URL | http://hebees-embedding:8000 |
| QUERY_EMBEDDING_SERVICE_URL | Query Embedding 서비스 URL | http://hebees-query-embedding:8000 |
| SEARCH_SERVICE_URL | Search 서비스 URL | http://hebees-search:8000 |
| CROSS_ENCODER_SERVICE_URL | Cross-Encoder 서비스 URL | http://hebees-cross-encoder:8000 |
| GENERATION_SERVICE_URL | Generation 서비스 URL | http://hebees-generation:8000 |

> Docker 네트워크 내부에서는 서비스명으로 접근합니다.

**3.7 외부 Embedding Provider**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| EMBEDDING_PROVIDER_URL | 외부 Embedding Provider URL | https://aloojgpo171my1-8000.proxy.runpod.net |

**3.8 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/RAG_Orchestrator.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

**3.9 환경 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ENVIRONMENT | 환경 이름 | production |
| DEBUG | 디버그 모드 | false |

## **4) 배포 절차**

**4.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: hebees-rag-orchestrator
- **네트워크**: app-network-test, app-network-prod, db-network

**4.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials)
2. Docker 이미지 빌드: docker build -t hebees/rag-orchestrator:${BUILD_NUMBER} .
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행 (환경 변수 주입)
5. Health Check: /health 엔드포인트 확인

**4.3 Docker 실행 명령어**

```jsx
docker run -d \
  --name hebees-rag-orchestrator \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --network db-network \
  --env-file .env \
  hebees/rag-orchestrator:${BUILD_NUMBER}
```

**5) 환경 변수 파일**

```jsx
# Server
HOST=0.0.0.0
PORT=8000

# CORS
ALLOWED_ORIGINS=https://www.ragextension.shop,https://dev.ragextension.shop

# Database
DB_HOST=database-mysql
DB_PORT=3306
DB_USERNAME=hebees_user
DB_PASSWORD=hebeespass

# Redis
REDIS_HOST=database-redis
REDIS_PORT=6379
REDIS_PASSWORD=
REDIS_DB=1

# Milvus
MILVUS_HOST=milvus-standalone
MILVUS_PORT=19530

# Gateway
GATEWAY_URL=http://rag-extension-gw:8000

# Services (Docker 네트워크 내부 서비스명)
EXTRACT_SERVICE_URL=http://hebees-extract:8000
CHUNKING_SERVICE_URL=http://hebees-chunking:8000
EMBEDDING_SERVICE_URL=http://hebees-embedding:8000
QUERY_EMBEDDING_SERVICE_URL=http://hebees-query-embedding:8000
SEARCH_SERVICE_URL=http://hebees-search:8000
CROSS_ENCODER_SERVICE_URL=http://hebees-cross-encoder:8000
GENERATION_SERVICE_URL=http://hebees-generation:8000

# External Embedding Provider
EMBEDDING_PROVIDER_URL=https://aloojgpo171my1-8000.proxy.runpod.net

# Logging
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false

# Environment
ENVIRONMENT=production
DEBUG=false
```

# **HEBEES Python Backend 포팅(배포) 매뉴얼 v1.0**

> 대상: 운영/개발 환경에 Python Backend 서비스(FastAPI)를 설치·구동·운영하려는 엔지니어
> 

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **Vector DB**: Milvus (pymilvus 2.4+)
- **Cache**: Redis (redis 7.0.1+)
- **Object Storage**: MinIO (minio 7.2.0)
- **HTTP Client**: HTTPX 0.28.1 (서비스 간 통신)
- **LLM Integration**: OpenAI API, Google Gemini API
- **Image Processing**: Pillow 10.4.0
- **Monitoring**: psutil 5.9.0+
- **Docs**: FastAPI 자체 Swagger UI
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv
- **의존성 관리**: pyproject.toml + uv.lock
- **빌드 도구**: hatchling

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.
> 

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.
> 

**3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |
| APP_NAME | 애플리케이션 이름 | HEBEES Python Backend Service |

**3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,https://www.ragextension.shop,https://dev.ragextension.shop,*.beta9.kr |

> 와일드카드 도메인 지원: *.beta9.kr 형식은 정규식으로 자동 변환됩니다.
> 

**3.3 MySQL**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_HOST | MySQL 호스트 | database-mysql |
| DB_PORT | MySQL 포트 | 3306 |
| DB_NAME | 데이터베이스 이름 | hebees-test |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

**3.4 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_URL | Redis 연결 URL | redis://:1q2w3e4r@database-redis:6379/1 |
| REDIS_DB | Redis DB 인덱스 | 1 |
| REDIS_METRICS_DB | 메트릭 전용 Redis DB 인덱스 | 8 |
| INGEST_META_TTL_SEC | Ingest 메타데이터 TTL (초) | 0 (0 이하 시 TTL 비활성화) |

**3.5 Milvus (Vector Database)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MILVUS_HOST | Milvus 호스트 | milvus_standalone |
| MILVUS_PORT | Milvus 포트 | 19530 |
| MILVUS_COLLECTION | Milvus 컬렉션 이름 | documents |
| MILVUS_PK_FIELD | Primary Key 필드명 | file_no |
| MILVUS_PATH_FIELD | 경로 필드명 | path |

**3.6 MinIO (Object Storage)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MINIO_ENDPOINT | MinIO 엔드포인트 | database-minio:9000 |
| MINIO_ACCESS_KEY | MinIO Access Key | s407 |
| MINIO_SECRET_KEY | MinIO Secret Key | 1q2w3e4r |
| MINIO_IMAGE_BUCKET_NAME | 이미지 버킷 이름 | image |
| MINIO_USE_SSL | SSL 사용 여부 | false |
| MINIO_API_PUBLIC_URL | MinIO API 공개 URL | https://storage.ragextension.shop |
| DEFAULT_PUBLIC_BUCKET | 기본 공개 버킷 | public |
| DEFAULT_TEST_BUCKET | 기본 테스트 버킷 | test |
| MINIO_REGION | MinIO 리전 | (선택 사항) |
| MINIO_USE_PRESIGNED_URL | Presigned URL 사용 여부 | false |

**3.7 외부 서비스 URL**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| INGEST_BASE_URL | RAG Orchestrator URL | http://hebees-rag-orchestrator:8000 |
| INGEST_PROCESS_URL | Ingest 프로세스 URL (선택) | http://hebees-rag-orchestrator:8000/ingest/process |
| INGEST_DELETE_URL | Ingest 삭제 URL (선택) | http://hebees-rag-orchestrator:8000/ingest/delete |

> Docker 네트워크 내부에서는 서비스명으로 접근합니다.
> 

**3.8 LLM API 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LLM_PROVIDER | LLM 제공자 (매출 리포트 AI 요약용) | gpt (또는 qwen) |
| OPENAI_API_KEY | OpenAI API Key | sk-proj-… |
| OPENAI_MODEL | OpenAI 모델명 | gpt-4o-mini |
| GEMINI_API_KEY | Google Gemini API Key | AIzaSy… |
| GEMINI_IMAGE_MODEL_NAME | Gemini 이미지 모델명 | gemini-2.5-flash-image |

**3.9 Runpod**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| RUNPOD_API_KEY | Runpod API Key | dev_change_me |

**3.10 모니터링**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| NETWORK_BANDWIDTH_MBPS | 네트워크 총 대역폭(Mbps) | 1000.0 (1Gbps) |

**3.11 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값), DEBUG |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/python-backend.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

## **4) 로컬 개발 절차**

**4.1 사전 준비물**

- Python 3.11+, uv, MySQL 8.x, Redis, Milvus, MinIO

**4.2 환경 변수 파일 생성**

프로젝트 루트에 .env 파일 생성:

```bash
# 기본 서버 설정
HOST=0.0.0.0
PORT=8000
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://www.ragextension.shop,https://dev.ragextension.shop
# DB 설정
DB_HOST=database-mysql
DB_PORT=3306
DB_NAME=hebees-test
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4
# Redis
REDIS_URL=redis://:1q2w3e4r@database-redis:6379/1
# Milvus 설정
MILVUS_HOST=milvus_standalone
MILVUS_PORT=19530
# MinIO 설정
MINIO_ENDPOINT=database-minio:9000
MINIO_ACCESS_KEY=s407
MINIO_SECRET_KEY=1q2w3e4r
MINIO_IMAGE_BUCKET_NAME=image
MINIO_USE_SSL=false
MINIO_API_PUBLIC_URL=https://storage.ragextension.shop
DEFAULT_PUBLIC_BUCKET=public
DEFAULT_TEST_BUCKET=test
# 외부 서비스
INGEST_BASE_URL=http://hebees-rag-orchestrator:8000
# LLM 설정LLM_PROVIDER=gpt
OPENAI_API_KEY=your_openai_api_key_here
OPENAI_MODEL=gpt-4o-mini
GEMINI_API_KEY=your_gemini_api_key_here
GEMINI_IMAGE_MODEL_NAME=gemini-2.5-flash-image
# Runpod
RUNPOD_API_KEY=dev_change_me
# 로그 레벨
LOGGING_LEVEL=DEBUG
```

**4.3 의존성 설치 & 실행**

```bash
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh
# 의존성 설치
uv sync --frozen --no-dev
# 개발 서버 실행
python run.py
# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**4.4 API 문서 접근**

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- Health Check: http://localhost:8000/health

## **5) 배포 절차**

**5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **Test 환경**: develop 브랜치 → hebees-python-backend
- **Prod 환경**: main 브랜치 → hebees-python-backend
- **네트워크**: app-network-test, app-network-prod, db-network

**5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials: `python-backend-repo.env`)
2. Docker 이미지 빌드: `docker build -t hebees/python-backend:${BUILD_NUMBER} .`
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행 (환경 변수 주입)
5. Health Check: `/health` 엔드포인트 확인

**5.3 Docker 실행 명령어**

```bash
docker run -d \  --name hebees-python-backend \  --restart unless-stopped \  --network app-network-test \  --env-file .env \  hebees/python-backend:${BUILD_NUMBER}
# 추가 네트워크 연결
docker network connect app-network-prod hebees-python-backend
docker network connect db-network hebees-python-backend
```

**5.4 Jenkins CI/CD**

프로젝트는 Jenkins 파이프라인을 통한 자동 배포를 지원합니다:

- **Jenkinsfile**: 프로젝트 루트에 위치
- **빌드 파라미터**:
    - `BUILD_PYTHON_BACKEND`: 수동 빌드 활성화 (기본값: true)
    - `BRANCH_TO_BUILD`: 빌드 대상 브랜치 (기본값: develop)
    - `CLEANUP_ONLY`: 오래된 컨테이너/이미지 정리만 수행 (기본값: false)
- **Credentials**: `python-backend-repo.env` (Jenkins credentials ID)

**파이프라인 단계**:
1. Checkout: 소스 코드 체크아웃
2. Prepare Docker Networks: Docker 네트워크 생성
3. Build Docker Image: Docker 이미지 빌드
4. Deploy Docker Container: 컨테이너 배포 및 다중 네트워크 연결
5. Cleanup: 오래된 이미지 정리

## **6) 주요 기능 및 API 엔드포인트**

**6.1 헬스체크**

- `GET /` - 서비스 상태 확인
- `GET /health` - 헬스체크 및 버전 정보

**6.2 파일 관리 (File Management)**

- `GET /api/v1/file-categories` - 파일 카테고리 목록 조회
- `POST /api/v1/files/upload` - 파일 업로드
- `GET /api/v1/files` - 파일 목록 조회
- `GET /api/v1/files/presigned` - Presigned URL 생성
- `GET /api/v1/files/presigned/{file_no}` - 파일 번호로 Presigned URL 조회
- `DELETE /api/v1/files/{file_no}` - 파일 삭제

**6.3 컬렉션 관리 (Collection Management)**

- `GET /api/v1/collections` - 컬렉션 목록 조회
- `POST /api/v1/collections` - 컬렉션 생성
- `PUT /api/v1/collections/{collection_id}` - 컬렉션 수정
- `DELETE /api/v1/collections/{collection_id}` - 컬렉션 삭제

**6.4 이미지 생성 (Image Generation)**

- `POST /api/v1/images/generate` - AI 이미지 생성
- `POST /api/v1/images/regenerate` - 이미지 재생성
- `GET /api/v1/images/{image_id}` - 이미지 조회

**6.5 RAG 설정 (RAG Settings)**

- **Ingest Template**:
    - `GET /api/v1/rag/ingest-templates` - Ingest 템플릿 목록
    - `POST /api/v1/rag/ingest-templates` - Ingest 템플릿 생성
    - `PUT /api/v1/rag/ingest-templates/{template_id}` - Ingest 템플릿 수정
    - `DELETE /api/v1/rag/ingest-templates/{template_id}` - Ingest 템플릿 삭제
- **Query Template**:
    - `GET /api/v1/rag/query-templates` - Query 템플릿 목록
    - `POST /api/v1/rag/query-templates` - Query 템플릿 생성
    - `PUT /api/v1/rag/query-templates/{template_id}` - Query 템플릿 수정
    - `DELETE /api/v1/rag/query-templates/{template_id}` - Query 템플릿 삭제
- **Prompt Template**:
    - `GET /api/v1/rag/prompt-templates` - Prompt 템플릿 목록
    - `POST /api/v1/rag/prompt-templates` - Prompt 템플릿 생성
    - `PUT /api/v1/rag/prompt-templates/{template_id}` - Prompt 템플릿 수정
    - `DELETE /api/v1/rag/prompt-templates/{template_id}` - Prompt 템플릿 삭제

**6.6 모니터링 (Monitoring)**

- `GET /api/v1/monitoring/cpu` - CPU 사용량 조회
- `GET /api/v1/monitoring/memory` - 메모리 사용량 조회
- `GET /api/v1/monitoring/network` - 네트워크 사용량 조회

**6.7 Runpod 관리**

- `GET /api/v1/runpod/pods` - Runpod 목록 조회
- `POST /api/v1/runpod/pods/{pod_id}/start` - Runpod 시작
- `POST /api/v1/runpod/pods/{pod_id}/stop` - Runpod 중지

**6.8 매출 리포트 (Sales Report)**

- `POST /api/v1/sales-reports/chain-summary` - AI 기반 매출 리포트 체인 요약 생성
- `POST /api/v1/sales-reports/summary` - AI 기반 매출 리포트 요약 생성

## **7) 데이터베이스 스키마**

**7.1 주요 테이블**

- **file** - 파일 정보 관리
- **file_category** - 파일 카테고리 관리
- **collection** - 컬렉션 정보 관리
- **ingest_template** - Ingest 전략 템플릿
- **query_template** - Query 전략 템플릿
- **offer** - 제안 정보 관리
- **user** - 사용자 정보 관리

**7.2 테스트 데이터 삽입**

테스트 데이터 삽입 스크립트:

```bash
python scripts/insert_test_data.py
```

## **8) 아키텍처 구성도**

```
┌─────────────────────────────────────────────────────────┐
│                   HEBEES Python Backend                  │
│                     (FastAPI 0.119.0)                    │
├─────────────────────────────────────────────────────────┤
│  Domains:                                                │
│  - File Management       - Collection Management         │
│  - Image Generation      - RAG Settings                  │
│  - Monitoring            - Runpod Management             │
│  - Sales Report (AI)                                     │
└───────────────┬─────────────────────────────────────────┘
                │
                ├──────────────┐
                │              │
        ┌───────▼──────┐  ┌───▼──────────┐
        │   MySQL      │  │    Redis     │
        │  (aiomysql)  │  │  (Lettuce)   │
        └──────────────┘  └──────────────┘
                │
        ┌───────▼──────────┐
        │     MinIO        │
        │ (Object Storage) │
        └──────────────────┘
                │
        ┌───────▼──────────┐
        │     Milvus       │
        │  (Vector DB)     │
        └──────────────────┘
                │
        ┌───────▼──────────┐
        │  RAG Orchestrator│
        │    (FastAPI)     │
        └──────────────────┘
                │
        ┌───────▼──────────┬──────────────┐
        │   OpenAI API     │  Gemini API  │
        │    (LLM)         │    (LLM)     │
        └──────────────────┴──────────────┘
```

## **9) 의존성 목록**

주요 의존성 패키지:

- **웹 프레임워크**: fastapi 0.119.0, uvicorn 0.38.0, starlette 0.48.0
- **데이터베이스**: aiomysql 0.2.0, sqlalchemy 2.0.44, pymysql 1.1.2
- **벡터 DB**: pymilvus 2.4+
- **캐시**: redis 7.0.1+
- **스토리지**: minio 7.2.0
- **HTTP 클라이언트**: httpx 0.28.1
- **검증**: pydantic 2.12.3, pydantic-settings 2.11.0
- **LLM**: openai 2.8.0+, google-genai 0.2.2
- **이미지**: Pillow 10.4.0
- **모니터링**: psutil 5.9.0+
- **유틸리티**: python-dotenv 1.1.1, pyyaml 6.0.3, jinja2 3.1.6+

전체 의존성은 `pyproject.toml` 파일 참조.

## **10) 트러블슈팅**

**10.1 데이터베이스 연결 오류**

- MySQL 서버가 실행 중인지 확인
- 네트워크 연결 확인 (Docker 네트워크: db-network)
- DB 계정 정보 및 권한 확인
- 방화벽 설정 확인

**10.2 MinIO 연결 오류**

- MinIO 서버 실행 상태 확인
- 엔드포인트 URL 및 Access Key/Secret Key 확인
- 버킷 생성 여부 확인
- SSL 설정 확인 (MINIO_USE_SSL)

**10.3 Milvus 연결 오류**

- Milvus 서버 실행 상태 확인
- 호스트 및 포트 설정 확인
- 컬렉션 존재 여부 확인
- 네트워크 연결 확인

**10.4 LLM API 오류**

- API Key 유효성 확인 (OPENAI_API_KEY, GEMINI_API_KEY)
- API 사용량 및 제한 확인
- 네트워크 연결 확인 (외부 API 호출)
- 모델명 정확성 확인

**10.5 로그 확인**

```bash
# Docker 컨테이너 로그 확인
docker logs hebees-python-backend
# 실시간 로그 스트리밍
docker logs -f hebees-python-backend
# 로그 파일 확인(LOG_FILE_ENABLED=true인 경우)
docker exec hebees-python-backend cat /var/log/hebees/python-backend.log
```

## **11) 보안 고려사항**

**11.1 환경 변수 보안**

- 모든 민감 정보(API Key, DB 비밀번호 등)는 환경 변수로 관리
- .env 파일은 절대 Git에 커밋하지 않음 (.gitignore에 포함)
- Jenkins credentials를 사용한 안전한 환경 변수 주입

**11.2 CORS 설정**

- 신뢰할 수 있는 도메인만 ALLOWED_ORIGINS에 추가
- 와일드카드 도메인 사용 시 보안 영향 고려

**11.3 API 보안**

- 필요 시 인증/인가 미들웨어 추가
- Rate Limiting 고려
- Input Validation 철저히 수행 (Pydantic 활용)

**11.4 컨테이너 보안**

- 비루트 사용자로 컨테이너 실행 (Dockerfile에 구현됨)
- 최소 권한 원칙 적용
- 정기적인 이미지 업데이트 및 취약점 스캔

## **12) 성능 최적화**

**12.1 데이터베이스 최적화**

- 적절한 인덱스 생성
- Connection Pooling 활용 (SQLAlchemy)
- 쿼리 최적화 및 N+1 문제 방지

**12.2 캐싱 전략**

- Redis를 활용한 자주 조회되는 데이터 캐싱
- Ingest 메타데이터 TTL 설정 활용

**12.3 벡터 DB 최적화**

- Milvus 인덱스 최적화
- 적절한 검색 파라미터 설정
- 벡터 차원 최적화

**12.4 애플리케이션 최적화**

- 비동기 처리 활용 (FastAPI async/await)
- 적절한 Worker 수 설정 (Uvicorn)
- 리소스 모니터링 및 병목 지점 파악

## **13) 버전 관리 및 업데이트**

**13.1 버전 정책**

- 의미론적 버전 관리 (Semantic Versioning)
- pyproject.toml의 version 필드 관리

**13.2 의존성 업데이트**

```bash
# 의존성 업데이트
uv sync --upgrade
# Lock 파일 재생성
uv lock
# 특정 패키지 업데이트
uv add package-name@latest
```

**13.3 마이그레이션**

- 데이터베이스 스키마 변경 시 마이그레이션 스크립트 작성
- 배포 전 마이그레이션 테스트 수행
- 롤백 계획 수립

# 포팅 메뉴얼

# **HEBEES Chunking 포팅(배포) 매뉴얼 v1.0**

> 대상: 운영/개발 환경에 Chunking Service(FastAPI, Python) 서비스를 설치·구동·운영하려는 엔지니어
> 

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **Cache**: Redis 5.0.0+
- **HTTP Client**: HTTPX 0.28.1
- **Machine Learning**: Transformers 4.30.0+, PyTorch 2.0.0+
- **Logging**: Loguru 0.7.2
- **Storage**: MinIO (S3-compatible object storage)
- **Docs**: FastAPI 자체 Swagger UI
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv (자동 설치)
- **의존성 관리**: pyproject.toml + uv.lock

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.
> 

### **주요 디렉토리 구조**

```
chunking-repo/
├── app/                    # 애플리케이션 코드
│   ├── __init__.py        # 버전 및 메타데이터
│   ├── main.py            # FastAPI 애플리케이션 진입점
│   ├── config.py          # 환경 설정
│   ├── core/              # 핵심 로직 (OpenAPI, 데이터베이스 등)
│   ├── middleware/        # 미들웨어 (CORS, 로깅 등)
│   ├── models/            # 데이터베이스 모델
│   ├── routers/           # API 라우터
│   ├── schemas/           # Pydantic 스키마
│   ├── service/           # 비즈니스 로직
│   └── src/               # 추가 소스 코드
├── run.py                 # 서버 실행 스크립트
├── Dockerfile             # Docker 이미지 빌드 설정
├── pyproject.toml         # Python 프로젝트 메타데이터 및 의존성
├── uv.lock                # 의존성 잠금 파일
├── requirements.txt       # pip 호환용 의존성 목록
└── Jenkinsfile            # CI/CD 파이프라인 설정
```

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.
> 

### **3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서버 이름 | HEBEES Chunking Service |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

### **3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,http://localhost:3000,https://dev.ragextension.shop,https://www.ragextension.shop |

> 와일드카드 도메인 지원: 필요 시 정규식으로 변환하여 사용할 수 있습니다.
> 

### **3.3 MySQL**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_HOST | MySQL 호스트 | database-mysql |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

> MySQL 포트는 기본값 3306을 사용합니다.
> 

### **3.4 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_HOST | Redis 호스트 | database-redis |
| REDIS_PORT | Redis 포트 | 6379 |
| REDIS_PASSWORD | Redis 비밀번호 | 1q2w3e4r |

### **3.5 MinIO (S3-compatible Object Storage)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MINIO_HOST | MinIO 호스트 | database-minio |
| MINIO_PORT | MinIO 포트 | 9000 |
| MINIO_USERNAME | MinIO 계정 | s407 |
| MINIO_PASSWORD | MinIO 비밀번호 | 1q2w3e4r |

> MinIO는 S3 호환 객체 스토리지로 파일 및 청크 데이터 저장에 사용됩니다.
> 

### **3.6 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/chunking.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

### **3.7 환경 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ENVIRONMENT | 환경 이름 | production |
| DEBUG | 디버그 모드 | false |

## **4) 로컬 개발 절차**

### **4.1 사전 준비물**

- Python 3.11+
- uv (Python 패키지 관리자)
- MySQL 8.x
- Redis 5.x+
- MinIO (선택사항, 로컬 개발 시)

### **4.2 환경 변수 주입(.env 예시)**

```bash
# ============================================# 애플리케이션 기본 설정# ============================================
APP_NAME=HEBEES Chunking Service
HOST=0.0.0.0
PORT=8000
# ============================================# CORS 설정# ============================================
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://dev.ragextension.shop,https://www.ragextension.shop
# ============================================# 로깅 설정# ============================================
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
LOG_FILE_PATH=/var/log/hebees/chunking.log
LOG_FILE_MAX_BYTES=10485760
LOG_FILE_BACKUP_COUNT=5
# ============================================# 환경 설정# ============================================
ENVIRONMENT=development
DEBUG=true
# ============================================# 데이터베이스 설정# ============================================
DB_HOST=localhost
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4
# ============================================# Redis 설정# ============================================
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=1q2w3e4r
# ============================================# MinIO 설정# ============================================
MINIO_HOST=localhost
MINIO_PORT=9000
MINIO_USERNAME=s407
MINIO_PASSWORD=1q2w3e4r
```

### **4.3 의존성 설치 & 실행**

```bash
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh
# 의존성 설치
uv sync --frozen --no-dev
# 개발 서버 실행
python run.py
# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### **4.4 API 문서 접근**

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- Health Check: http://localhost:8000/health

## **5) 배포 절차**

### **5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: hebees-chunking
- **네트워크**: app-network-test, app-network-prod, db-network
- **이미지명**: hebees/chunking:${BUILD_NUMBER}

### **5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials)
2. uv.lock 업데이트 (필요 시)
3. Docker 이미지 빌드: `docker build -t hebees/chunking:${BUILD_NUMBER} .`
4. 기존 컨테이너 중지 및 삭제
5. 새 컨테이너 실행 (환경 변수 주입)
6. Health Check: /health 엔드포인트 확인

### **5.3 Docker 실행 명령어**

```bash
docker run -d \
  --name hebees-chunking \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --network db-network \
  --env-file .env \
  hebees/chunking:${BUILD_NUMBER}
```

> 중요: 여러 네트워크에 연결하여 다른 서비스들과 통신할 수 있도록 합니다.
> 

### **5.4 Jenkins 파이프라인을 통한 배포**

Jenkins를 통한 자동 배포 시 다음 파라미터를 사용할 수 있습니다:

- **BUILD_CHUNKING**: Chunking Service를 수동으로 빌드하고 배포하려면 체크 (기본값: true)
- **BRANCH_TO_BUILD**: 수동 빌드 시 기준 브랜치 선택 (develop 또는 main, 기본값: develop)
- **CLEANUP_ONLY**: 오래된 컨테이너/이미지 정리만 수행 (기본값: false)

**배포 프로세스**:
1. Checkout: 소스 코드 체크아웃
2. Update uv.lock: 의존성 잠금 파일 업데이트
3. Prepare Docker Networks: Docker 네트워크 생성
4. Build Docker Image: Docker 이미지 빌드
5. Deploy Docker Container: 컨테이너 배포
6. Health Check: 서비스 헬스 체크 (최대 30회 재시도, 2초 간격)

## **6) 주요 API 엔드포인트**

### **6.1 기본 엔드포인트**

- **GET /** - 서비스 상태 확인
    - Response: `{"message": "Hebees Chunking Service is running"}`
- **GET /health** - 헬스체크
    - Response: `{"status": "healthy", "version": "0.0.1"}`
- **GET /docs** - FastAPI Swagger UI
- **GET /redoc** - ReDoc 문서
- **GET /openapi.json** - OpenAPI 스키마

### **6.2 Chunking 관련 엔드포인트**

> 실제 API 엔드포인트는 app/routers/ 디렉토리에 정의되어 있습니다.
> 

## **7) 의존성 상세**

### **7.1 핵심 프레임워크**

- **FastAPI 0.119.0**: 고성능 웹 프레임워크
- **Uvicorn 0.38.0**: ASGI 서버
- **Pydantic 2.12.3**: 데이터 검증 및 설정 관리
- **Starlette 0.48.0**: ASGI 툴킷

### **7.2 데이터베이스 & 캐시**

- **aiomysql 0.2.0**: 비동기 MySQL 클라이언트
- **SQLAlchemy 2.0.44**: ORM
- **PyMySQL 1.1.2**: MySQL 커넥터
- **Redis 5.0.0+**: 캐싱 및 세션 관리

### **7.3 머신러닝**

- **Transformers 4.30.0+**: Hugging Face 트랜스포머 라이브러리
- **PyTorch 2.0.0+**: 딥러닝 프레임워크

### **7.4 유틸리티**

- **HTTPX 0.28.1**: 비동기 HTTP 클라이언트
- **python-dotenv 1.1.1**: 환경 변수 관리
- **Loguru 0.7.2**: 구조화된 로깅
- **PyYAML 6.0.3**: YAML 설정 파싱

## **8) 트러블슈팅**

### **8.1 Docker 빌드 실패**

**증상**: Docker 이미지 빌드 중 uv 설치 또는 의존성 동기화 실패

**해결방법**:

```bash
# uv.lock 파일 재생성
docker run --rm -v "$PWD":/app -w /app python:3.11-slim bash -c "
    apt-get update && apt-get install -y curl ca-certificates && \
    curl -fsSL https://astral.sh/uv/install.sh | sh && \
    /root/.local/bin/uv lock
"

# 다시 빌드
docker build -t hebees/chunking:test .
```

### **8.2 Health Check 실패**

**증상**: 컨테이너 배포 후 /health 엔드포인트가 응답하지 않음

**해결방법**:

```bash
# 컨테이너 로그 확인
docker logs hebees-chunking
# 컨테이너 내부 접근
docker exec -it hebees-chunking /bin/bash
# 서비스 포트 확인
docker exec hebees-chunking netstat -tuln | grep 8000
```

### **8.3 데이터베이스 연결 실패**

**증상**: MySQL 또는 Redis 연결 오류

**해결방법**:

```bash
# Docker 네트워크 확인
docker network inspect db-network
# 환경 변수 확인
docker exec hebees-chunking env | grep -E "DB_|REDIS_"
# 네트워크 연결 테스트
docker exec hebees-chunking ping -c 3 database-mysql
docker exec hebees-chunking ping -c 3 database-redis
```

### **8.4 의존성 버전 충돌**

**증상**: pyproject.toml과 uv.lock 간 버전 불일치

**해결방법**:

```bash
# uv.lock 재생성 (로컬)
uv lock --upgrade

# 또는 Docker에서 실행
docker run --rm -v "$PWD":/app -w /app python:3.11-slim bash -c "
    apt-get update && apt-get install -y curl ca-certificates && \
    curl -fsSL https://astral.sh/uv/install.sh | sh && \
    /root/.local/bin/uv lock --upgrade
"
```

## **9) 보안 권장사항**

### **9.1 환경 변수 관리**

- `.env` 파일을 Git에 커밋하지 마세요 (`.gitignore`에 추가됨)
- Jenkins Credentials에 민감한 정보 저장
- 프로덕션 환경에서는 Secrets Management 도구 사용 권장 (AWS Secrets Manager, HashiCorp Vault 등)

### **9.2 네트워크 보안**

- 필요한 네트워크만 연결
- 외부 노출이 필요 없는 서비스는 내부 네트워크만 사용
- API Gateway를 통한 접근 제어 권장

### **9.3 컨테이너 보안**

- 비루트 사용자로 실행 (Dockerfile에 구현됨)
- 정기적인 의존성 업데이트 및 취약점 스캔
- 이미지 크기 최소화 (멀티스테이지 빌드 사용)

## **10) 모니터링 및 로깅**

### **10.1 로그 수집**

- 컨테이너 로그: `docker logs hebees-chunking -f`
- 파일 로그 활성화 시: `/var/log/hebees/chunking.log`
- Loguru를 통한 구조화된 로그 출력

### **10.2 Health Check**

- 엔드포인트: `GET /health`
- Jenkins 파이프라인에서 자동 헬스 체크 수행
- 최대 30회 재시도 (2초 간격)

### **10.3 성능 모니터링**

- FastAPI 내장 문서로 API 성능 확인
- Prometheus + Grafana 연동 권장 (필요 시)

# HEBEES Cross-Encoder 포팅(배포) 매뉴얼 v1.0

> 대상: 운영/개발 환경에 Cross-Encoder 서비스(FastAPI)를 설치·구동·운영하려는 엔지니어
> 

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **Cache**: Redis (redis >=5.0.0)
- **ML Framework**: PyTorch (>=2.1.0)
- **Cross-Encoder Model**: Sentence Transformers (>=2.7.0), Transformers (>=4.40.0)
- **Docs**: FastAPI 자체 Swagger UI
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv
- **의존성 관리**: pyproject.toml + uv.lock

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.
> 

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.
> 

### **3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서버 이름 | HEBEES Cross-Encoder Service |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

### **3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,https://www.ragextension.shop,*.beta9.kr |

> 와일드카드 도메인 지원: *.beta9.kr 형식은 정규식으로 자동 변환됩니다.
> 

### **3.3 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_HOST | Redis 호스트 | database-redis |
| REDIS_PORT | Redis 포트 | 6379 |
| REDIS_USERNAME | Redis 계정 (Optional) | default |
| REDIS_PASSWORD | Redis 비밀번호 (Optional) | 1q2w3e4r |
| REDIS_DB | Redis DB 인덱스 | 1 |

### **3.4 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/cross-encoder.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

### **3.5 환경 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ENVIRONMENT | 환경 이름 | production |
| DEBUG | 디버그 모드 | false |

## **4) 로컬 개발 절차**

### **4.1 사전 준비물**

- Python 3.11+
- uv (Python 패키지 관리자)
- Redis 서버 (선택사항)

### **4.2 환경 변수 파일 생성 (.env 예시)**

프로젝트 루트에 `.env` 파일 생성:

```bash
# 애플리케이션 설정
APP_NAME=HEBEES Cross-Encoder Service
HOST=0.0.0.0
PORT=8000
# CORS 설정
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://www.ragextension.shop,https://dev.ragextension.shop
# Redis 설정
REDIS_HOST=database-redis
REDIS_PORT=6379
REDIS_USERNAME=REDIS_PASSWORD=1q2w3e4r
REDIS_DB=1
# 로깅 설정
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
# 환경 설정
ENVIRONMENT=development
DEBUG=true
```

### **4.3 의존성 설치 & 실행**

```bash
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh
# 의존성 설치
uv sync --frozen --no-dev
# 개발 서버 실행
python run.py
# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### **4.4 API 문서 접근**

- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **OpenAPI Schema**: http://localhost:8000/openapi.json
- **Health Check**: http://localhost:8000/health

## **5) 배포 절차**

### **5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: hebees-cross-encoder
- **네트워크**: app-network-test, app-network-prod, db-network

### **5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials)
2. Docker 이미지 빌드: `docker build -t hebees/cross-encoder:${BUILD_NUMBER} .`
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행 (환경 변수 주입)
5. Health Check: `/health` 엔드포인트 확인

### **5.3 Docker 이미지 빌드**

```bash
docker build -t hebees/cross-encoder:${BUILD_NUMBER} .
```

### **5.4 Docker 실행 명령어**

```bash
docker run -d \
  --name hebees-cross-encoder \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --network db-network \
  --env APP_NAME="HEBEES Cross-Encoder Service" \
  --env HOST=0.0.0.0 \
  --env PORT=8000 \
  --env REDIS_HOST=database-redis \
  --env REDIS_PORT=6379 \
  --env REDIS_PASSWORD=${REDIS_PASSWORD} \
  --env REDIS_DB=1 \
  --env LOGGING_LEVEL=INFO \
  --env LOG_FILE_ENABLED=false \
  --env ENVIRONMENT=production \
  --env DEBUG=false \
  hebees/cross-encoder:${BUILD_NUMBER}
```

> 중요: 여러 네트워크에 연결하여 다른 서비스들과 통신할 수 있도록 합니다.
> 

## **6) API 엔드포인트 구조**

### **6.1 주요 엔드포인트**

- **GET /** - 서비스 상태 확인
    - Response: `{"message": "Hebees Cross Encoder Service is running"}`
- **GET /health** - 헬스체크
    - Response: `{"status": "healthy", "version": "0.0.1"}`
- **GET /docs** - FastAPI Swagger UI
- **GET /redoc** - ReDoc 문서
- **GET /openapi.json** - OpenAPI 스키마

### **6.2 Cross-Encoder API**

### **POST /process**

- **설명**: Cross-Encoder를 사용한 재순위화(Re-ranking) 처리
- **Request Body**:
    
    ```json
      {
        "query": "검색 쿼리 텍스트",
        "candidateEmbeddings": [
          {
            "page": 1,
            "chunk_id": 0,
            "text": "청크 텍스트",
            "score": 0.85,
            "fileNo": "file123",
            "fileName": "document.pdf"
          }
        ],
        "crossEncoderStrategy": "crossEncoder",
        "crossEncoderParameter": {
          "top_k": 10,
          "model_name": "cross-encoder/ms-marco-MiniLM-L-12-v2"
        }
      }
    ```
    
- **Response**:
    
    ```json
      {
        "status": 200,
        "code": "OK",
        "message": "요청에 성공하였습니다.",
        "isSuccess": true,
        "result": {
          "query": "검색 쿼리 텍스트",
          "retrievedChunks": [...],
          "count": 10,
          "strategy": "crossEncoder",
          "parameters": {...}
        }
      }
    ```
    

### **POST /process/image**

- **설명**: 이미지 관련 Cross-Encoder 재순위화 처리
- **Request/Response**: `/process`와 동일한 형식

## **7) 주요 기능**

### **7.1 Cross-Encoder Re-ranking**

Cross-Encoder 서비스는 검색 결과를 재순위화하여 더 관련성 높은 결과를 제공합니다:

1. **Query & Candidates**: 사용자 쿼리와 후보 청크 목록을 입력받음
2. **Strategy Loading**: 동적으로 Cross-Encoder 전략 모듈 로드
3. **Re-ranking**: Sentence Transformers 기반 Cross-Encoder 모델로 재점수 계산
4. **Response**: 재순위화된 결과를 점수 순으로 반환

### **7.2 동적 전략 로딩**

- `crossEncoderStrategy` 파라미터로 전략 모듈 지정
- `app.src.{strategy_name}` 모듈을 동적으로 임포트
- 전략 클래스 인스턴스를 생성하여 `rerank()` 메서드 호출

### **7.3 메트릭 수집**

- `@with_cross_encoder_metrics` 데코레이터로 API 성능 측정
- 처리 시간, 성공/실패 횟수, 평균 응답 시간 등 수집

## **8) 의존성 목록**

### **8.1 핵심 의존성**

| 패키지 | 버전 | 용도 |
| --- | --- | --- |
| fastapi | 0.119.0 | 웹 프레임워크 |
| uvicorn | 0.38.0 | ASGI 서버 |
| pydantic | 2.12.3 | 데이터 검증 |
| pydantic-settings | 2.11.0 | 환경 변수 관리 |

### **8.2 데이터베이스**

| 패키지 | 버전 | 용도 |
| --- | --- | --- |
| aiomysql | 0.2.0 | 비동기 MySQL 드라이버 |
| sqlalchemy | 2.0.44 | ORM |
| redis | >=5.0.0 | Redis 클라이언트 |

### **8.3 ML & NLP**

| 패키지 | 버전 | 용도 |
| --- | --- | --- |
| sentence-transformers | >=2.7.0 | Cross-Encoder 모델 |
| torch | >=2.1.0 | PyTorch 딥러닝 프레임워크 |
| transformers | >=4.40.0 | Hugging Face Transformers |
| numpy | >=1.24.0 | 수치 계산 |

### **8.4 기타**

| 패키지 | 버전 | 용도 |
| --- | --- | --- |
| httpx | 0.28.1 | HTTP 클라이언트 |
| loguru | >=0.7.0 | 로깅 |
| python-dotenv | 1.1.1 | .env 파일 로딩 |

## **9) 트러블슈팅**

### **9.1 일반적인 문제**

### 의존성 설치 실패

```bash
# uv 캐시 클리어 후 재설치
rm -rf ~/.cache/uv
uv sync --frozen --no-dev
```

### Redis 연결 실패

- Redis 서버가 실행 중인지 확인
- `REDIS_HOST`, `REDIS_PORT` 환경 변수 확인
- 네트워크 연결 상태 확인

### Docker 빌드 실패

```bash
# 빌드 캐시 없이 재빌드
docker build --no-cache -t hebees/cross-encoder:latest .
```

### 모델 로딩 실패

- 충분한 메모리가 있는지 확인 (최소 4GB 권장)
- PyTorch 및 CUDA 호환성 확인
- 모델 파일 다운로드 및 캐시 확인

### **9.2 로그 확인**

```bash
# Docker 컨테이너 로그 확인
docker logs hebees-cross-encoder
# 실시간 로그 스트리밍
docker logs -f hebees-cross-encoder
# 최근 100줄 로그
docker logs --tail 100 hebees-cross-encoder
```

### **9.3 Health Check**

```bash
# 서비스 상태 확인
curl http://localhost:8000/health
# 예상 응답
{  "status": "healthy",
  "version": "0.0.1"}
```

## **10) 보안 고려사항**

### **10.1 인증 & 권한**

- 현재 버전은 기본 인증이 없음 (API Gateway에서 처리 권장)
- 내부 네트워크에서만 접근 가능하도록 구성

### **10.2 CORS 설정**

- `ALLOWED_ORIGINS` 환경 변수로 허용된 도메인 관리
- 프로덕션에서는 와일드카드() 사용 금지

### **10.3 민감 정보 관리**

- `.env` 파일을 Git에 커밋하지 않음 (`.gitignore`에 추가)
- Redis 비밀번호 등 민감 정보는 환경 변수로 주입
- 프로덕션 환경에서는 Secrets Management 도구 사용 권장

## **11) 성능 최적화**

### **11.1 모델 캐싱**

- Cross-Encoder 모델은 첫 로딩 시 다운로드되어 캐시됨
- `~/.cache/huggingface` 디렉터리에 저장
- Docker 볼륨으로 캐시 디렉터리 마운트 권장

### **11.2 배치 처리**

- 여러 쿼리를 배치로 처리하면 성능 향상
- GPU 사용 시 배치 크기 증가 권장

### **11.3 리소스 할당**

- **최소 사양**: 2 CPU, 4GB RAM
- **권장 사양**: 4 CPU, 8GB RAM
- **GPU**: CUDA 지원 GPU 사용 시 성능 대폭 향상

## **12) 모니터링 & 메트릭**

### **12.1 메트릭 수집**

- API 호출 횟수, 성공률, 응답 시간 등 수집
- `@with_cross_encoder_metrics` 데코레이터로 자동 수집

### **12.2 로깅**

- **레벨**: DEBUG, INFO, WARNING, ERROR, CRITICAL
- **파일 로깅**: `LOG_FILE_ENABLED=true` 설정 시 활성화
- **구조화된 로깅**: JSON 형식으로 로그 출력 (Loguru 사용)

### **12.3 Health Check**

- `/health` 엔드포인트로 서비스 상태 확인
- Kubernetes Liveness/Readiness Probe에 활용

## **13) 버전 정보**

- **서비스 버전**: 0.0.1
- **Python**: 3.11+
- **FastAPI**: 0.119.0
- **Uvicorn**: 0.38.0
- **Sentence Transformers**: >=2.7.0

---

## **부록 A: 환경 변수 전체 목록**

```bash
# Server
APP_NAME=HEBEES Cross-Encoder Service
HOST=0.0.0.0
PORT=8000
# CORS
ALLOWED_ORIGINS=https://www.ragextension.shop,https://dev.ragextension.shop
# Redis
REDIS_HOST=database-redis
REDIS_PORT=6379
REDIS_USERNAME=REDIS_PASSWORD=1q2w3e4r
REDIS_DB=1
# Logging
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
LOG_FILE_PATH=/var/log/hebees/cross-encoder.log
LOG_FILE_MAX_BYTES=10485760
LOG_FILE_BACKUP_COUNT=5
# Environment
ENVIRONMENT=production
DEBUG=false
```

## **부록 B: Docker Compose 예시**

```yaml
version: '3.8'

services:
  cross-encoder:
    image: hebees/cross-encoder:latest
    container_name: hebees-cross-encoder
    restart: unless-stopped
    networks:
      - app-network-prod
      - db-network
    environment:
      - APP_NAME=HEBEES Cross-Encoder Service
      - HOST=0.0.0.0
      - PORT=8000
      - REDIS_HOST=database-redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=1q2w3e4r
      - REDIS_DB=1
      - LOGGING_LEVEL=INFO
      - ENVIRONMENT=production
      - DEBUG=false
    volumes:
      - huggingface-cache:/root/.cache/huggingface
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

networks:
  app-network-prod:
    external: true
  db-network:
    external: true

volumes:
  huggingface-cache:
```

# HEBEES Embedding 포팅(배포) 매뉴얼 v1.0

> 대상: 운영/개발 환경에 Embedding Service(FastAPI)를 설치·구동·운영하려는 엔지니어
> 

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **Vector DB**: Milvus (pymilvus 2.4+)
- **Cache**: Redis 5.0+
- **HTTP Client**: HTTPX 0.28.1 (서비스 간 통신)
- **ML Framework**: Sentence Transformers 2.2+, PyTorch 2.0+
- **Logging**: Loguru 0.7+
- **Docs**: FastAPI 자체 Swagger UI
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv (자동 설치)
- **의존성 관리**: pyproject.toml + uv.lock
- **빌드 모드**:
    - Docker 멀티스테이지 빌드 (builder + runtime)
    - 비루트 사용자로 실행 (보안 강화)

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.
> 

**주요 디렉토리 구조**:

```
embedding-repo/
├── app/
│   ├── core/           # 설정 및 OpenAPI 커스터마이징
│   ├── middleware/     # 미들웨어 (메트릭 등)
│   ├── models/         # 데이터베이스 모델
│   ├── routers/        # API 라우터
│   ├── schemas/        # Request/Response 스키마
│   ├── service/        # 비즈니스 로직 (Milvus, Runpod 등)
│   ├── src/            # 임베딩 로직 (dense, base)
│   ├── __init__.py     # 버전 정보
│   ├── config.py       # 레거시 설정
│   └── main.py         # FastAPI 애플리케이션 진입점
├── Dockerfile          # 멀티스테이지 빌드 설정
├── Jenkinsfile         # CI/CD 파이프라인
├── pyproject.toml      # 프로젝트 메타데이터 및 의존성
├── uv.lock             # 의존성 잠금 파일
├── run.py              # 애플리케이션 실행 스크립트
└── README.md
```

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.
> 

### **3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서버 이름 | HEBEES Embedding Service |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

### **3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,http://localhost:3000,https://dev.ragextension.shop,https://www.ragextension.shop |

### **3.3 MySQL**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_HOST | MySQL 호스트 | database-mysql |
| DB_PORT | MySQL 포트 | 3306 |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

> 데이터베이스 이름은 코드 내에서 hebees-test로 하드코딩되어 있습니다.
> 

### **3.4 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_HOST | Redis 호스트 | database-redis |
| REDIS_PORT | Redis 포트 | 16379 |
| REDIS_USERNAME | Redis 계정 (선택) | default |
| REDIS_PASSWORD | Redis 비밀번호 (선택) | 1q2w3e4r |
| REDIS_DB | Redis DB 인덱스 | 1 |

### **3.5 Milvus (Vector Database)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MILVUS_HOST | Milvus 호스트 | milvus-standalone |
| MILVUS_PORT | Milvus 포트 | 19530 |

### **3.6 외부 Embedding Provider**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| EMBEDDING_PROVIDER_URL | 외부 Embedding Provider URL | https://aloojgpo171my1-8000.proxy.runpod.net |

> 애플리케이션 시작 시 MySQL DB에서 RUNPOD 정보(NAME='EMBEDDING')를 조회하여 이 값을 자동으로 업데이트합니다. DB 조회 실패 시 환경 변수 값을 사용합니다.
> 

### **3.7 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/embedding.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

### **3.8 환경 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ENVIRONMENT | 환경 이름 | production |
| DEBUG | 디버그 모드 | false |

## **4) 로컬 개발 절차**

### **4.1 사전 준비물**

- Python 3.11+
- uv
- MySQL 8.x
- Milvus (로컬 또는 Docker)
- Redis (로컬 또는 Docker)

### **4.2 환경 변수 주입(.env 예시)**

프로젝트 루트에 `.env` 파일 생성:

```bash
# 애플리케이션 설정
APP_NAME=HEBEES Embedding Service
HOST=0.0.0.0
PORT=8000
# CORS
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://www.ragextension.shop,https://dev.ragextension.shop
# MySQL 설정
DB_HOST=database-mysql
DB_PORT=3306
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4
# Redis 설정
REDIS_HOST=database-redis
REDIS_PORT=16379
REDIS_USERNAME=default
REDIS_PASSWORD=1q2w3e4r
REDIS_DB=1
# Milvus 설정
MILVUS_HOST=milvus-standalone
MILVUS_PORT=19530
# 외부 Embedding Provider
EMBEDDING_PROVIDER_URL=https://aloojgpo171my1-8000.proxy.runpod.net
# 로깅
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
# 환경
ENVIRONMENT=development
DEBUG=true
```

### **4.3 의존성 설치 & 실행**

```bash
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh
# 의존성 설치
uv sync --frozen --no-dev
# 개발 서버 실행
python run.py
# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### **4.4 API 문서 접근**

- **Root**: http://localhost:8000/
- **Health Check**: http://localhost:8000/health
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc
- **OpenAPI Schema**: http://localhost:8000/openapi.json

## **5) 배포 절차**

### **5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: hebees-embedding
- **네트워크**: app-network-test, app-network-prod, db-network
- **CI/CD**: Jenkins 파이프라인 자동 배포

### **5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials)
2. Docker 이미지 빌드: `docker build -t hebees/embedding:${BUILD_NUMBER} .`
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행 (환경 변수 주입)
5. Health Check: `/health` 엔드포인트 확인 (최대 30회 재시도, 2초 간격)

### **5.3 Docker 빌드 상세**

**멀티스테이지 빌드 프로세스**:

1. **Builder Stage** (python:3.11-slim):
    - 필수 패키지 설치 (curl, ca-certificates, python3-venv, build-essential, gcc)
    - uv 설치 및 의존성 동기화 (`uv sync --frozen --no-dev`)
    - `.venv` 가상환경 생성
2. **Runtime Stage** (python:3.11-slim):
    - Builder에서 생성된 `.venv` 복사
    - 애플리케이션 코드 복사
    - 비루트 사용자(`app`) 생성 및 권한 설정
    - 로그 디렉토리 생성 (`/var/log/hebees`)

### **5.4 Docker 실행 명령어**

```bash
docker run -d \
  --name hebees-embedding \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --network db-network \
  --env-file .env \
  hebees/embedding:${BUILD_NUMBER}
```

> 중요: 여러 네트워크에 연결하여 다른 서비스들(MySQL, Redis, Milvus 등)과 통신할 수 있도록 합니다.
> 

### **5.5 Jenkins 환경 변수 (Credentials)**

Jenkins에서 `embedding-repo.env` credentials 파일을 사용하여 환경 변수를 주입합니다. 해당 파일은 다음 내용을 포함해야 합니다:

```bash
APP_NAME=HEBEES Embedding Service
HOST=0.0.0.0
PORT=8000
ALLOWED_ORIGINS=https://www.ragextension.shop,https://dev.ragextension.shop
DB_HOST=database-mysql
DB_PORT=3306
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4
REDIS_HOST=database-redis
REDIS_PORT=16379
REDIS_USERNAME=default
REDIS_PASSWORD=1q2w3e4r
REDIS_DB=1
MILVUS_HOST=milvus-standalone
MILVUS_PORT=19530
EMBEDDING_PROVIDER_URL=https://aloojgpo171my1-8000.proxy.runpod.net
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
ENVIRONMENT=production
DEBUG=false
```

## **6) Jenkins CI/CD 파이프라인**

### **6.1 파이프라인 개요**

- **트리거**: GitLab Webhook (push 이벤트) 또는 수동 빌드
- **파라미터**:
    - `BUILD_EMBEDDING`: Embedding Service 빌드 활성화 (기본값: true)
    - `BRANCH_TO_BUILD`: 수동 빌드 시 브랜치 선택 (develop 또는 main)
    - `CLEANUP_ONLY`: 오래된 이미지 정리만 수행 (기본값: false)

### **6.2 파이프라인 스테이지**

1. **Checkout**: Git 저장소 체크아웃
2. **Prepare Docker Networks**: Docker 네트워크 생성 (app-network-test, app-network-prod, db-network)
3. **Build Docker Image**: Docker 이미지 빌드 (`hebees/embedding:${BUILD_NUMBER}`)
4. **Deploy Docker Container**:
    - 기존 컨테이너 중지/삭제
    - 새 컨테이너 실행 (환경 변수 주입)
5. **Health Check**:
    - `/health` 엔드포인트 확인 (최대 30회 재시도)
    - 성공 시 파이프라인 완료
6. **Cleanup Old Images**: 선택적 이미지 정리

### **6.3 알림 (Mattermost)**

빌드 결과에 따라 Mattermost로 알림 전송:
- **성공**: 작성자, 브랜치, 커밋 정보
- **실패**: 에러 로그 (마지막 150줄, 민감정보 마스킹)

## **7) API 엔드포인트**

### **7.1 주요 엔드포인트**

- `GET /` - 서비스 상태 메시지
- `GET /health` - 헬스체크 (버전 정보 포함)
- `GET /docs` - FastAPI Swagger UI
- `GET /redoc` - ReDoc 문서
- `GET /openapi.json` - OpenAPI 스키마

### **7.2 비즈니스 로직 엔드포인트**

실제 임베딩 처리 엔드포인트는 `app/routers/router.py`에 정의되어 있습니다. 주요 기능:
- 텍스트 임베딩 생성
- 이미지 임베딩 생성
- Milvus 벡터 DB와 연동
- 임베딩 메트릭 수집

## **8) 애플리케이션 라이프사이클**

### **8.1 시작 시 동작**

`lifespan` 이벤트에서 다음 작업 수행:
1. MySQL DB에서 RUNPOD 정보 조회 (`NAME='EMBEDDING'`)
2. 조회 성공 시 `settings.embedding_provider_url` 업데이트
3. 조회 실패 시 환경 변수 기본값 사용
4. 로깅으로 시작 상태 기록

### **8.2 종료 시 동작**

- 정리 작업 수행 (필요 시)
- 종료 로깅

## **9) 의존성 관리**

### **9.1 주요 의존성**

- **Web Framework**: FastAPI 0.119.0, Uvicorn 0.38.0
- **Database**: aiomysql 0.2.0, SQLAlchemy 2.0.44, PyMySQL 1.1.2
- **Vector DB**: pymilvus 2.4+
- **Cache**: redis 5.0+
- **HTTP**: httpx 0.28.1, httpcore 1.0.9
- **ML/AI**: sentence-transformers 2.2+, torch 2.0+
- **Config**: pydantic 2.12.3, pydantic-settings 2.11.0, python-dotenv 1.1.1, environs 9.5.0
- **Logging**: loguru 0.7+
- **Utilities**: pyyaml 6.0.3, marshmallow 3.21.3

### **9.2 의존성 업데이트**

```bash
# 의존성 업데이트 (pyproject.toml 수정 후)
uv sync
# 잠금 파일 갱신
uv lock
```

## **10) 트러블슈팅**

### **10.1 일반적인 문제**

**문제**: 컨테이너가 시작되지 않음
**해결**:
- 로그 확인: `docker logs hebees-embedding`
- 환경 변수 확인: `.env` 파일 또는 Jenkins credentials
- 네트워크 연결 확인: `docker network inspect app-network-test`

**문제**: Health check 실패
**해결**:
- 컨테이너 내부 로그 확인
- MySQL, Redis, Milvus 연결 상태 확인
- RUNPOD 정보 조회 실패 가능성 확인

**문제**: RUNPOD URL 업데이트 실패
**해결**:
- MySQL DB에 `NAME='EMBEDDING'` RUNPOD 레코드 존재 확인
- DB 연결 권한 확인
- 로그에서 상세 오류 메시지 확인

### **10.2 로그 확인**

```bash
# 실시간 로그
docker logs -f hebees-embedding
# 마지막 100줄
docker logs --tail 100 hebees-embedding
# 컨테이너 내부 로그 파일 (LOG_FILE_ENABLED=true인 경우)
docker exec hebees-embedding tail -f /var/log/hebees/embedding.log
```

### **10.3 디버그 모드**

로컬 개발 시 디버그 모드 활성화:

```bash
# .env 파일
DEBUG=true
LOGGING_LEVEL=DEBUG
```

## **11) 보안 고려사항**

- 비루트 사용자(`app`)로 컨테이너 실행
- 민감 정보(DB 비밀번호, API 키)는 환경 변수로 주입
- Jenkins credentials로 민감 정보 관리
- Mattermost 알림에서 민감정보 자동 마스킹
- CORS 설정으로 허용된 Origin만 접근 가능

## **12) 성능 최적화**

- Docker 멀티스테이지 빌드로 이미지 크기 최적화
- `uv sync --frozen --no-dev`로 개발 의존성 제외
- Redis 캐싱 활용
- 비동기 처리 (FastAPI + aiomysql)

## **13) 모니터링**

- Health Check 엔드포인트 (`/health`)
- 메트릭 미들웨어 (`app/middleware/metrics_middleware.py`)
- Loguru 구조화 로깅
- Jenkins 빌드 알림 (Mattermost)

## **14) 버전 관리**

- **현재 버전**: 0.0.1 (pyproject.toml)
- 버전 정보는 `app/__init__.py`에서 관리
- API 응답에 버전 포함 (`/health`)

---

## **15) 체크리스트**

배포 전 확인사항:

- [ ]  Python 3.11+ 설치 확인
- [ ]  uv 설치 확인
- [ ]  환경 변수 파일 준비 (.env 또는 Jenkins credentials)
- [ ]  MySQL, Redis, Milvus 서비스 실행 확인
- [ ]  Docker 네트워크 생성 확인
- [ ]  RUNPOD 정보 DB 등록 확인 (`NAME='EMBEDDING'`)
- [ ]  Jenkins credentials 설정 확인 (`embedding-repo.env`)
- [ ]  로그 디렉토리 권한 확인 (`/var/log/hebees`)
- [ ]  Health Check 엔드포인트 정상 응답 확인
- [ ]  API 문서 접근 가능 확인 (`/docs`)

---

# 포팅 매뉴얼

# **HEBEES Extract 포팅(배포) 매뉴얼 v1.0**

> 대상: 운영/개발 환경에 Extract Service(FastAPI, Python 3.11) 서비스를 설치·구동·운영하려는 엔지니어
> 

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **Cache**: Redis 5.0.0+
- **Object Storage**: MinIO 7.2.7
- **PDF Processing**: PyMuPDF 1.26.0, pdfplumber 0.10.0, camelot-py 0.11.0
- **Document Processing**: python-docx 1.2.0, openpyxl 3.1.5
- **AI/ML**: OpenAI API, OpenCV (headless)
- **External Services**: Marker (PDF), YOLO (Table Detection), Qwen (LLM)
- **HTTP Client**: HTTPX 0.28.1
- **Logging**: Loguru 0.7.2
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv (자동 설치)
- **의존성 관리**: pyproject.toml + uv.lock

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.
> 

### **주요 디렉토리 구조**

```
extract-repo/
├── app/
│   ├── core/              # 설정 및 OpenAPI
│   │   ├── settings.py    # 환경 변수 설정
│   │   └── openapi.py     # Swagger 커스터마이징
│   ├── middleware/        # 미들웨어 (metrics 등)
│   ├── models/           # DB 모델 및 연결
│   │   ├── database.py   # MySQL 연결
│   │   └── runpod.py     # Runpod 테이블 모델
│   ├── routers/          # API 라우터
│   │   └── router.py     # 메인 라우터
│   ├── schemas/          # Pydantic 스키마
│   │   ├── request/      # 요청 스키마
│   │   └── response/     # 응답 스키마
│   ├── service/          # 비즈니스 로직
│   │   ├── extract_service.py           # 추출 서비스
│   │   ├── extract_metrics_service.py   # 메트릭 수집
│   │   ├── runpod_service.py           # Runpod 연동
│   │   ├── ingest_progress_client.py   # 진행상황 전송
│   │   └── minio_client.py             # MinIO 클라이언트
│   ├── src/              # 문서 파서 구현
│   │   ├── base.py       # 베이스 추출기
│   │   ├── pyMuPDF.py    # PDF 추출 (PyMuPDF)
│   │   ├── marker.py     # PDF 추출 (Marker)
│   │   ├── docx.py       # Word 문서 추출
│   │   ├── openpyxl.py   # Excel 추출
│   │   └── txt.py        # 텍스트 추출
│   └── main.py           # FastAPI 애플리케이션
├── Dockerfile            # Docker 이미지 빌드
├── Jenkinsfile          # CI/CD 파이프라인
├── pyproject.toml       # 의존성 정의
├── uv.lock             # Lock 파일
└── run.py              # 실행 스크립트
```

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.
> 

### **3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서비스 이름 | HEBEES Extract Service |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

### **3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,http://localhost:3000,https://www.ragextension.shop |

### **3.3 MySQL**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_HOST | MySQL 호스트 | database-mysql |
| DB_PORT | MySQL 포트 | 3306 |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

> Database URL은 자동 생성: mysql+aiomysql://{username}:{password}@{host}:{port}/hebees-test
> 

### **3.4 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_HOST | Redis 호스트 | database-redis |
| REDIS_PORT | Redis 포트 | 16379 |
| REDIS_USERNAME | Redis 계정 | default (Optional) |
| REDIS_PASSWORD | Redis 비밀번호 | 1q2w3e4r (Optional) |
| REDIS_DB | Redis DB 인덱스 | 1 |

### **3.5 MinIO (Object Storage)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MINIO_HOST | MinIO 호스트 | minio |
| MINIO_PORT | MinIO 포트 | 9000 |
| MINIO_USERNAME | MinIO Access Key | minioadmin |
| MINIO_PASSWORD | MinIO Secret Key | minioadmin |

### **3.6 외부 AI/ML 서비스**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MARKER_PROVIDER_URL | Marker PDF 변환 서비스 URL | https://e508kqibffcog4-8000.proxy.runpod.net |
| YOLO_PROVIDER_URL | YOLO 테이블 감지 서비스 URL | https://7g415voh7b00k4-7002.proxy.runpod.net |
| QWEN_BASE_URL | Qwen LLM 서비스 URL (Ollama) | http://apik.co.kr:11434/ |

> 중요: Marker, YOLO, Qwen 서비스 URL은 애플리케이션 시작 시 DB(RUNPOD 테이블)에서 동적으로 조회하여 업데이트됩니다. 위 값은 기본값이며, DB에 값이 없을 경우에만 사용됩니다.
> 

### **3.7 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/extract.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

### **3.8 환경 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ENVIRONMENT | 환경 이름 | production |
| DEBUG | 디버그 모드 | false |

## **4) 로컬 개발 절차**

### **4.1 사전 준비물**

- Python 3.11+
- uv 패키지 매니저
- MySQL 8.x
- Redis 5.x+
- MinIO (선택)

### **4.2 환경 변수 주입(.env 예시)**

프로젝트 루트에 `.env` 파일 생성:

```bash
# 서버 설정
APP_NAME=HEBEES Extract Service
HOST=0.0.0.0
PORT=8000
# CORS
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000
# MySQL
DB_HOST=localhost
DB_PORT=3306
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4
# Redis
REDIS_HOST=localhost
REDIS_PORT=16379
REDIS_USERNAME=default
REDIS_PASSWORD=1q2w3e4r
REDIS_DB=1
# MinIO
MINIO_HOST=localhost
MINIO_PORT=9000
MINIO_USERNAME=minioadmin
MINIO_PASSWORD=minioadmin
# External AI Services (기본값, DB에서 동적 업데이트됨)
MARKER_PROVIDER_URL=https://e508kqibffcog4-8000.proxy.runpod.net
YOLO_PROVIDER_URL=https://7g415voh7b00k4-7002.proxy.runpod.net
QWEN_BASE_URL=http://apik.co.kr:11434/
# 로깅
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
# 환경
ENVIRONMENT=development
DEBUG=true
```

### **4.3 의존성 설치 & 실행**

```bash
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh
# 의존성 설치
uv sync --frozen --no-dev
# 개발 서버 실행
python run.py
# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### **4.4 API 문서 접근**

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- Health Check: http://localhost:8000/health
- Root: http://localhost:8000/

## **5) 배포 절차**

### **5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: hebees-extract
- **네트워크**: app-network-test, app-network-prod, db-network
- **포트**: 내부 8000 (외부 노출 안 함, 네트워크 내부 통신)

### **5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials)
2. Docker 이미지 빌드: `docker build -t hebees/extract:${BUILD_NUMBER} .`
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행 (환경 변수 주입)
5. Health Check: `/health` 엔드포인트 확인 (최대 30회, 2초 간격)

### **5.3 Docker 실행 명령어**

```bash
docker run -d \
  --name hebees-extract \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --network db-network \
  --env-file .env \
  hebees/extract:${BUILD_NUMBER}
```

> 중요:
- 여러 네트워크에 연결하여 다른 서비스들과 통신할 수 있도록 합니다.
- --env-file 옵션으로 환경 변수를 주입합니다.
- 컨테이너는 포트를 외부에 노출하지 않고 Docker 네트워크 내부에서만 통신합니다.
> 

### **5.4 Docker 이미지 빌드 과정**

Dockerfile은 Multi-stage 빌드를 사용하여 이미지 크기를 최적화합니다:

1. **Builder Stage**:
    - Python 3.11-slim 베이스
    - uv 설치 및 의존성 동기화
    - 가상환경(.venv) 생성
2. **Runtime Stage**:
    - Python 3.11-slim 베이스
    - Builder에서 가상환경 복사
    - 비루트 사용자(app) 생성
    - 로그 디렉터리(/var/log/hebees) 생성

### **5.5 Jenkins CI/CD 파이프라인**

### **파이프라인 파라미터**

| 파라미터 | 기본값 | 설명 |
| --- | --- | --- |
| BUILD_EXTRACT | true | Extract Service 수동 빌드 여부 |
| BRANCH_TO_BUILD | develop | 빌드 대상 브랜치 |
| CLEANUP_ONLY | false | 이미지 정리만 수행 |

### **주요 스테이지**

1. **Checkout**: 소스코드 체크아웃
2. **Prepare Docker Networks**: Docker 네트워크 생성
3. **Build Docker Image**: Docker 이미지 빌드
4. **Deploy Docker Container**: 컨테이너 배포 (기존 컨테이너 중지/삭제 후 신규 실행)
5. **Health Check**: 헬스 체크 (최대 30회 재시도)
6. **Cleanup Old Images**: 오래된 이미지 정리 (선택)

### **빌드 트리거**

- GitLab Push 웹훅 (자동)
- 수동 빌드 (Jenkins UI)

### **알림**

- Mattermost 웹훅을 통한 빌드 성공/실패 알림
- 실패 시 최근 150줄 로그 포함 (민감정보 마스킹)

## **6) 주요 API 엔드포인트**

### **6.1 Health Check**

- `GET /` - 서비스 상태 확인
- `GET /health` - 헬스 체크 (버전 정보 포함)

### **6.2 문서 추출**

Extract Service는 다양한 문서 형식을 지원합니다:

- **PDF**: PyMuPDF, Marker (외부 서비스)
- **Word**: python-docx
- **Excel**: openpyxl
- **Text**: 일반 텍스트 파일

> 자세한 API 스펙은 Swagger UI(/docs) 참조
> 

## **7) 특수 기능 및 주의사항**

### **7.1 동적 서비스 URL 업데이트**

애플리케이션은 시작 시 DB의 `RUNPOD` 테이블에서 다음 서비스 주소를 조회하여 동적으로 업데이트합니다:

- **MARKER**: PDF 변환 서비스
- **YOLO**: 테이블 감지 서비스
- **qwen3**: Qwen LLM 서비스

DB에 값이 없으면 환경 변수의 기본값을 사용합니다.

### **7.2 MinIO 연동**

MinIO는 문서 파일 저장 및 조회에 사용됩니다. MinIO 클라이언트는 `app/service/minio_client.py`에 구현되어 있습니다.

### **7.3 진행상황 전송**

추출 작업의 진행상황은 `ingest_progress_client.py`를 통해 Redis 또는 다른 서비스로 전송됩니다.

### **7.4 메트릭 수집**

`extract_metrics_service.py`는 추출 작업의 메트릭(처리 시간, 성공/실패 등)을 수집합니다.

## **8) 문제 해결**

### **8.1 컨테이너 시작 실패**

- 로그 확인: `docker logs hebees-extract`
- 환경 변수 확인: `docker exec hebees-extract env`
- DB/Redis/MinIO 연결 확인

### **8.2 Health Check 실패**

- 컨테이너 상태 확인: `docker ps -a | grep hebees-extract`
- 네트워크 연결 확인: `docker network inspect app-network-test`
- 포트 바인딩 확인

### **8.3 의존성 설치 실패**

- Python 버전 확인: `python --version` (3.11+ 필수)
- uv 버전 확인: `uv --version`
- 캐시 정리: `uv cache clean`

### **8.4 외부 서비스 연결 실패**

- Marker/YOLO/Qwen 서비스 상태 확인
- DB의 RUNPOD 테이블 확인
- 네트워크 연결 및 방화벽 확인

## **9) 버전 정보**

- **Extract Service**: 0.0.1
- **FastAPI**: 0.119.0
- **Python**: 3.11
- **uv**: Latest (자동 설치)

---

# 포팅 매뉴얼

# **HEBEES Generation 포팅(배포) 매뉴얼 v1.0**

> 대상: 운영/개발 환경에 Generation 서비스(FastAPI, LangChain, LLM)를 설치·구동·운영하려는 엔지니어
> 

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44), MongoDB (Motor 3.3.0)
- **Cache**: Redis
- **LLM Framework**: LangChain 1.0.3 (langchain-openai, langchain-ollama, langchain-mongodb)
- **AI Models**: OpenAI, Ollama/Qwen (RunPod 동적 주소 지원)
- **HTTP Client**: HTTPX 0.28.1
- **Docs**: FastAPI 자체 Swagger UI
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv (자동 설치)
- **의존성 관리**: pyproject.toml + uv.lock

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.
> 

### 주요 의존성

| 패키지 | 버전 | 용도 |
| --- | --- | --- |
| fastapi | 0.119.0 | API 프레임워크 |
| uvicorn | 0.38.0 | ASGI 서버 |
| langchain | 1.0.3 | LLM 오케스트레이션 |
| langchain-openai | 1.0.1 | OpenAI 통합 |
| langchain-ollama | 1.0.0 | Ollama/Qwen 통합 |
| langchain-mongodb | 0.7.0 | MongoDB 벡터 저장소 |
| openai | 1.54.0+ | OpenAI API 클라이언트 |
| transformers | 4.30.0+ | 토큰화 |
| tiktoken | 0.8.0+ | 토큰 카운팅 |
| sqlalchemy | 2.0.44 | ORM |
| aiomysql | 0.2.0 | MySQL 비동기 드라이버 |
| motor | 3.3.0+ | MongoDB 비동기 드라이버 |
| pymongo | 4.6.0+ | MongoDB 클라이언트 |
| redis | 5.0.0+ | Redis 클라이언트 |
| httpx | 0.28.1 | HTTP 클라이언트 |
| loguru | 0.7.2+ | 로깅 |

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.
> 

### **3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서버 이름 | HEBEES Generation Service |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

### **3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,http://localhost:3000,https://www.ragextension.shop,https://dev.ragextension.shop |

### **3.3 OpenAI API**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| OPENAI_API_KEY | OpenAI API 키 | sk-… |

> OpenAI 모델 사용 시 반드시 필요합니다.
> 

### **3.4 Qwen/Ollama 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| QWEN_BASE_URL | Qwen/Ollama 서비스 URL (DB에서 동적 업데이트) | http://apik.co.kr:11434/ |

> 앱 시작 시 RunPod DB에서 qwen3 이름의 주소를 조회하여 자동 업데이트됩니다. DB에 정보가 없으면 기본값을 사용합니다.
> 

### **3.5 MySQL**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_HOST | MySQL 호스트 | database-mysql |
| DB_PORT | MySQL 포트 | 3306 |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

> 데이터베이스 이름은 hebees-test로 하드코딩되어 있습니다 (settings.py 참고).
> 

### **3.6 MongoDB**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MONGO_HOST | MongoDB 호스트 | database-mongodb |
| MONGO_PORT | MongoDB 포트 | 27017 |
| MONGO_USERNAME | MongoDB 계정 | s407 |
| MONGO_PASSWORD | MongoDB 비밀번호 | 1q2w3e4r |
| MONGO_DATABASE | MongoDB 데이터베이스 | hebees |

### **3.7 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_HOST | Redis 호스트 | database-redis |
| REDIS_PORT | Redis 포트 | 6379 |
| REDIS_USERNAME | Redis 계정 (선택) | default |
| REDIS_PASSWORD | Redis 비밀번호 (선택) | 1q2w3e4r |
| REDIS_DB | Redis DB 인덱스 | 1 |

### **3.8 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/generation.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

### **3.9 환경 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ENVIRONMENT | 환경 이름 | production |
| DEBUG | 디버그 모드 | false |

## **4) 로컬 개발 절차**

### **4.1 사전 준비물**

- Python 3.11+
- uv (Python 패키지 관리자)
- MySQL 8.x
- MongoDB 4.x+
- Redis 6.x+

### **4.2 환경 변수 파일 생성**

프로젝트 루트에 `.env` 파일 생성:

```bash
# 서버 설정
APP_NAME=HEBEES Generation Service
HOST=0.0.0.0
PORT=8000
# CORS
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://www.ragextension.shop,https://dev.ragextension.shop
# OpenAI
OPENAI_API_KEY=sk-your-openai-api-key-here
# Qwen/Ollama (기본값, DB에서 자동 업데이트됨)
QWEN_BASE_URL=http://apik.co.kr:11434/
# MySQL
DB_HOST=database-mysql
DB_PORT=3306
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4
# MongoDB
MONGO_HOST=database-mongodb
MONGO_PORT=27017
MONGO_USERNAME=s407
MONGO_PASSWORD=1q2w3e4r
MONGO_DATABASE=hebees
# Redis
REDIS_HOST=database-redis
REDIS_PORT=6379
REDIS_USERNAME=default
REDIS_PASSWORD=1q2w3e4r
REDIS_DB=1
# 로깅
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
# 환경
ENVIRONMENT=development
DEBUG=true
```

### **4.3 의존성 설치 & 실행**

```bash
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh
# 의존성 설치
uv sync --frozen --no-dev
# 개발 서버 실행
python run.py
# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### **4.4 API 문서 접근**

- **Root**: http://localhost:8000/
- **Health Check**: http://localhost:8000/health
- **Swagger UI**: http://localhost:8000/docs
- **ReDoc**: http://localhost:8000/redoc

## **5) 배포 절차**

### **5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: hebees-generation
- **네트워크**: app-network-test, app-network-prod, db-network
- **Jenkins 자동 배포**: develop 브랜치 푸시 시 자동 빌드/배포

### **5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials: `generation-repo.env`)
2. Docker 이미지 빌드: `docker build -t hebees/generation:${BUILD_NUMBER} .`
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행 (환경 변수 주입)
5. Health Check: `/health` 엔드포인트 확인 (최대 30회 재시도, 2초 간격)

### **5.3 Docker 실행 명령어**

```bash
docker run -d \
  --name hebees-generation \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --network db-network \
  --env-file .env \
  hebees/generation:${BUILD_NUMBER}
```

> 중요: 여러 네트워크에 연결하여 다른 서비스들(MySQL, MongoDB, Redis, Gateway 등)과 통신할 수 있도록 합니다.
> 

### **5.4 Jenkins 파이프라인**

프로젝트는 Jenkins 자동 배포를 지원합니다:

- **자동 트리거**: develop 브랜치 푸시 시 GitLab 웹훅으로 자동 빌드
- **수동 빌드**: `BUILD_GENERATION` 파라미터로 수동 빌드 가능
- **브랜치 선택**: `BRANCH_TO_BUILD` 파라미터로 develop 또는 main 선택
- **자동 정리**: 오래된 이미지 정리 옵션 (`CLEANUP_ONLY`)
- **Mattermost 알림**: 빌드 성공/실패 시 자동 알림

**주요 Stage:**

1. **Checkout**: 소스 코드 체크아웃
2. **Update uv.lock**: uv lock 파일 업데이트 (의존성 잠금)
3. **Prepare Docker Networks**: Docker 네트워크 생성
4. **Build Docker Image**: Docker 이미지 빌드
5. **Deploy Docker Container**: 컨테이너 배포 (환경 변수 파일 자동 주입)
6. **Health Check**: 서비스 헬스 체크 (30회 재시도, 2초 간격)
7. **Cleanup Old Images**: 오래된 이미지 정리 (선택)

## **6) 주요 기능 및 API**

### **6.1 헬스체크**

- **GET** `/health` - 서비스 헬스 체크

```json
{  "status": "healthy",  "version": "0.0.1"}
```

### **6.2 Generation API**

Generation 서비스는 LangChain을 활용하여 LLM 기반 텍스트 생성을 제공합니다.

- **핵심 기능**:
    - OpenAI 모델 통합 (GPT-3.5, GPT-4 등)
    - Ollama/Qwen 모델 통합 (오픈소스 LLM)
    - MongoDB를 활용한 대화 이력 관리
    - Redis 기반 캐싱
    - RunPod 동적 주소 관리 (DB에서 자동 조회)
    - 스트리밍 응답 지원

### **6.3 서비스 구조**

```
app/
├── main.py                  # FastAPI 앱 진입점
├── core/
│   ├── settings.py          # 환경 설정
│   ├── database.py          # MySQL/MongoDB 연결
│   ├── retriever.py         # 검색 로직
│   ├── custom_chat_history.py  # 대화 이력 관리
│   ├── memory_manager.py    # 메모리 관리
│   └── openapi.py           # OpenAPI 커스터마이징
├── routers/
│   └── router.py            # API 라우터
├── service/
│   ├── history_stream_service.py  # 스트리밍 서비스
│   ├── generation_metrics_service.py  # 메트릭 수집
│   └── runpod_service.py    # RunPod DB 조회
├── schemas/
│   ├── request/
│   │   └── generationRequest.py  # 요청 스키마
│   └── response/
│       ├── generationProcessResponse.py  # 응답 스키마
│       └── errorResponse.py      # 에러 스키마
├── models/
│   └── runpod.py            # RunPod 모델
└── src/
    ├── base.py              # Base LLM
    ├── openai.py            # OpenAI 통합
    └── ollama.py            # Ollama/Qwen 통합
```

## **7) 운영 가이드**

### **7.1 로그 확인**

```bash
# 컨테이너 로그 확인
docker logs -f hebees-generation
# 로그 파일 확인 (LOG_FILE_ENABLED=true 시)
docker exec hebees-generation tail -f /var/log/hebees/generation.log
```

### **7.2 서비스 재시작**

```bash
# 컨테이너 재시작
docker restart hebees-generation
# 컨테이너 중지
docker stop hebees-generation
# 컨테이너 시작
docker start hebees-generation
```

### **7.3 디버깅**

```bash
# 컨테이너 내부 접속
docker exec -it hebees-generation /bin/bash
# Python 환경 확인
python --versionuv --version
# 환경 변수 확인
env | grep -E "(DB_|MONGO_|REDIS_|OPENAI_|QWEN_)"
```

### **7.4 모니터링**

- **Health Check**: `/health` 엔드포인트 모니터링
- **API Docs**: `/docs` 엔드포인트로 API 상태 확인
- **로그 레벨**: `LOGGING_LEVEL` 환경 변수로 조정 (DEBUG, INFO, WARNING, ERROR)

## **8) 트러블슈팅**

### **8.1 일반 문제**

| 문제 | 원인 | 해결 방법 |
| --- | --- | --- |
| 컨테이너 시작 실패 | 환경 변수 미설정 | `.env` 파일 또는 `--env-file` 확인 |
| DB 연결 실패 | MySQL/MongoDB 미실행 | DB 컨테이너 상태 확인 및 재시작 |
| Redis 연결 실패 | Redis 미실행 | Redis 컨테이너 상태 확인 |
| OpenAI API 에러 | API 키 오류 | `OPENAI_API_KEY` 확인 |
| Qwen 연결 실패 | RunPod 주소 오류 | DB의 RunPod 정보 확인 또는 `QWEN_BASE_URL` 수동 설정 |

### **8.2 의존성 문제**

```bash
# uv.lock 업데이트
docker run --rm -v "$PWD":/app -w /app python:3.11-slim bash -c "
    apt-get update -qq && apt-get install -y -qq curl ca-certificates && \
    curl -fsSL https://astral.sh/uv/install.sh | sh && \
    /root/.local/bin/uv lock
"

# 의존성 재설치
uv sync --frozen --no-dev
```

### **8.3 네트워크 문제**

```bash
# Docker 네트워크 생성
docker network create app-network-test
docker network create app-network-prod
docker network create db-network
# 네트워크 연결 확인
docker network inspect app-network-test
docker network inspect db-network
```

## **9) 보안 고려사항**

### **9.1 환경 변수 보안**

- **민감 정보**: `.env` 파일은 절대 Git에 커밋하지 마세요
- **Jenkins Credentials**: Jenkins에 `generation-repo.env` credential로 저장
- **API 키**: OpenAI API 키는 반드시 안전하게 관리

### **9.2 네트워크 보안**

- **내부 통신**: Docker 네트워크를 통한 내부 서비스 간 통신
- **외부 노출**: 필요한 경우에만 포트를 외부에 노출
- **CORS**: `ALLOWED_ORIGINS`에 허용된 도메인만 명시

### **9.3 컨테이너 보안**

- **비루트 사용자**: Dockerfile에서 `app` 사용자로 실행
- **최소 권한**: 필요한 권한만 부여
- **이미지 스캔**: 정기적으로 Docker 이미지 보안 스캔

## **10) 참고사항**

### **10.1 버전 관리**

- **Python**: 3.11 이상 필수
- **uv**: 최신 버전 권장
- **Docker**: 20.10 이상 권장

### **10.2 성능 최적화**

- **Redis 캐싱**: 반복 요청에 대한 응답 캐싱
- **MongoDB 인덱싱**: 대화 이력 조회 성능 향상
- **비동기 I/O**: aiomysql, motor를 통한 비동기 DB 연결

### **10.3 확장성**

- **수평 확장**: 여러 컨테이너 인스턴스 실행 가능 (로드 밸런서 필요)
- **캐싱 전략**: Redis를 통한 응답 캐싱으로 LLM API 비용 절감
- **DB 최적화**: 연결 풀 설정으로 DB 성능 향상

---

# HEBEES Ingest 포팅(배포) 매뉴얼 v1.0

> 대상: 운영/개발 환경에 Ingest Service(FastAPI)를 설치·구동·운영하려는 엔지니어
> 

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **Cache**: Redis 7.0.1+
- **HTTP Client**: HTTPX 0.28.1 (서비스 간 통신)
- **Logging**: Loguru 0.7.2
- **Docs**: FastAPI 자체 Swagger UI
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv
- **의존성 관리**: pyproject.toml + uv.lock

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.
> 

### **2.1 주요 의존성**

| 패키지 | 버전 | 용도 |
| --- | --- | --- |
| FastAPI | 0.119.0 | 웹 프레임워크 |
| Uvicorn | 0.38.0 | ASGI 서버 |
| SQLAlchemy | 2.0.44 | ORM |
| aiomysql | 0.2.0 | MySQL 비동기 드라이버 |
| Redis | 7.0.1+ | 캐시 및 세션 관리 |
| HTTPX | 0.28.1 | HTTP 클라이언트 |
| Loguru | 0.7.2 | 로깅 |
| Pydantic | 2.12.3 | 데이터 검증 |

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.
> 

### **3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서버 이름 | HEBEES Ingest Service |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

### **3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,https://www.ragextension.shop,*.beta9.kr |

> 와일드카드 도메인 지원: *.beta9.kr 형식은 정규식으로 자동 변환됩니다.
> 

### **3.3 Database (MySQL)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_HOST | MySQL 호스트 | database-mysql |
| DB_PORT | MySQL 포트 | 3306 |
| DB_NAME | 데이터베이스 이름 | hebees-test |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

### **3.4 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_HOST | Redis 호스트 | database-redis |
| REDIS_PORT | Redis 포트 | 6379 |
| REDIS_USERNAME | Redis 계정 (선택) | default |
| REDIS_PASSWORD | Redis 비밀번호 | 1q2w3e4r |

> Docker 네트워크 내부에서는 서비스명으로 접근합니다.
> 

### **3.5 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/ingest.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

### **3.6 환경 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ENVIRONMENT | 환경 이름 | production |
| DEBUG | 디버그 모드 | false |

## **4) 로컬 개발 절차**

### **4.1 사전 준비물**

- Python 3.11+
- uv (Python 패키지 관리자)
- MySQL 8.x
- Redis 7.x

### **4.2 환경 변수 주입(.env 예시)**

프로젝트 루트에 .env 파일 생성:

```bash
# ============================================# 애플리케이션 기본 설정# ============================================
APP_NAME=HEBEES Ingest Service
HOST=0.0.0.0
PORT=8000
# ============================================# CORS 설정# ============================================
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://dev.ragextension.shop,https://www.ragextension.shop
# ============================================# 로깅 설정# ============================================
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
LOG_FILE_PATH=/var/log/hebees/ingest.log
LOG_FILE_MAX_BYTES=10485760
LOG_FILE_BACKUP_COUNT=5
# ============================================# 환경 설정# ============================================
ENVIRONMENT=development
DEBUG=true
# ============================================# 데이터베이스 설정 (MySQL)# ============================================
DB_HOST=localhost
DB_PORT=3306
DB_NAME=hebees-test
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4
# ============================================# Redis 설정# ============================================
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=1q2w3e4r
```

### **4.3 의존성 설치 & 실행**

```bash
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh
# 의존성 설치
uv sync --frozen --no-dev
# 개발 서버 실행
python run.py
# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### **4.4 API 문서 접근**

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc

## **5) 배포 절차**

### **5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: hebees-ingest
- **네트워크**: app-network-test, app-network-prod, db-network

### **5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials)
2. uv.lock 업데이트 (선택사항)
3. Docker 이미지 빌드: `docker build -t hebees/ingest:${BUILD_NUMBER} .`
4. 기존 컨테이너 중지 및 삭제
5. 새 컨테이너 실행 (환경 변수 주입)
6. Health Check: `/health` 엔드포인트 확인

### **5.3 Docker 이미지 빌드**

```bash
# 이미지 빌드
docker build -t hebees/ingest:latest .
# 특정 태그로 빌드
docker build -t hebees/ingest:${BUILD_NUMBER} .
```

### **5.4 Docker 실행 명령어**

```bash
docker run -d \
  --name hebees-ingest \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --network db-network \
  --env APP_NAME="HEBEES Ingest Service" \
  --env HOST=0.0.0.0 \
  --env PORT=8000 \
  --env ALLOWED_ORIGINS="https://www.ragextension.shop,https://dev.ragextension.shop" \
  --env DB_HOST=database-mysql \
  --env DB_PORT=3306 \
  --env DB_NAME=hebees-test \
  --env DB_USERNAME=s407test \
  --env DB_PASSWORD=q1w2e3r4 \
  --env REDIS_HOST=database-redis \
  --env REDIS_PORT=6379 \
  --env REDIS_PASSWORD=1q2w3e4r \
  --env LOGGING_LEVEL=INFO \
  --env ENVIRONMENT=production \
  --env DEBUG=false \
  hebees/ingest:latest
```

> 중요: 여러 네트워크에 연결하여 다른 서비스들과 통신할 수 있도록 합니다.
> 

### **5.5 환경별 배포 구분**

**Test 환경 (develop 브랜치)**:
- 네트워크: app-network-test, db-network
- 환경 변수: ENVIRONMENT=development

**Production 환경 (main 브랜치)**:
- 네트워크: app-network-prod, db-network
- 환경 변수: ENVIRONMENT=production, DEBUG=false

## **6) Jenkins CI/CD 파이프라인**

### **6.1 파이프라인 구성**

```groovy
pipeline {
    agent any

    parameters {
        booleanParam(name: 'BUILD_INGEST', defaultValue: true, description: 'Ingest Service 빌드 및 배포')
        string(name: 'BRANCH_TO_BUILD', defaultValue: 'develop', description: '빌드 대상 브랜치')
        booleanParam(name: 'CLEANUP_ONLY', defaultValue: false, description: '정리 작업만 수행')
    }

    environment {
        INGEST_IMAGE_NAME = "hebees/ingest"
        INGEST_CONTAINER = "hebees-ingest"
        APP_NETWORK_TEST = "app-network-test"
        APP_NETWORK_PROD = "app-network-prod"
        DB_NETWORK = "db-network"
    }

    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Update uv.lock') {
            steps {
                sh '''
                docker run --rm -v "$PWD":/app -w /app python:3.11-slim bash -c "
                    apt-get update -qq && apt-get install -y -qq curl ca-certificates && \\
                    curl -fsSL https://astral.sh/uv/install.sh | sh && \\
                    /root/.local/bin/uv lock && \\
                    chown -R $(id -u):$(id -g) uv.lock
                "
                '''
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${INGEST_IMAGE_NAME}:${BUILD_NUMBER} ."
            }
        }

        stage('Deploy') {
            steps {
                sh '''
                # 기존 컨테이너 중지 및 삭제
                docker stop ${INGEST_CONTAINER} || true
                docker rm ${INGEST_CONTAINER} || true

                # 새 컨테이너 실행
                docker run -d \\
                  --name ${INGEST_CONTAINER} \\
                  --restart unless-stopped \\
                  --network ${APP_NETWORK_TEST} \\
                  --network ${DB_NETWORK} \\
                  --env-file .env \\
                  ${INGEST_IMAGE_NAME}:${BUILD_NUMBER}
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                sleep 5
                curl -f http://localhost:8000/health || exit 1
                '''
            }
        }

        stage('Cleanup Old Images') {
            steps {
                sh '''
                docker image prune -f --filter "label=app=hebees-ingest"
                docker images ${INGEST_IMAGE_NAME} --format "{{.ID}} {{.CreatedAt}}" | \\
                    sort -rk 2 | tail -n +4 | awk '{print $1}' | xargs -r docker rmi || true
                '''
            }
        }
    }
}
```

### **6.2 주요 스테이지 설명**

1. **Checkout**: 소스 코드 체크아웃
2. **Update uv.lock**: Python 의존성 잠금 파일 업데이트
3. **Build Docker Image**: Docker 이미지 빌드
4. **Deploy**: 컨테이너 배포
5. **Health Check**: 헬스체크 확인
6. **Cleanup Old Images**: 오래된 이미지 정리

## **7) Dockerfile 구조**

### **7.1 Multi-stage Build**

```docker
# Stage 1: Builder
FROM python:3.11-slim AS builder
WORKDIR /app

# 필수 패키지 설치
RUN apt-get update && apt-get install -y \
    curl ca-certificates python3-venv build-essential gcc \
    && update-ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# 의존성 메타데이터 복사
COPY pyproject.toml uv.lock ./

# uv 설치 및 의존성 동기화
RUN curl -fsSL https://astral.sh/uv/install.sh | sh && \
    install -m 0755 /root/.local/bin/uv /usr/local/bin/uv && \
    uv sync --frozen --no-dev

# Stage 2: Runtime
FROM python:3.11-slim
WORKDIR /app

# 빌더에서 가상환경 복사
COPY --from=builder /app/.venv /app/.venv
COPY --from=builder /app/pyproject.toml /app/uv.lock ./

# 애플리케이션 코드 복사
COPY . .

# 가상환경 활성화
ENV PATH="/app/.venv/bin:${PATH}"

# 비루트 사용자 생성 및 권한 설정
RUN useradd --create-home --shell /bin/bash app && \
    mkdir -p /var/log/hebees && \
    chown -R app:app /app /var/log/hebees

USER app

CMD ["python", "run.py"]
```

### **7.2 보안 및 최적화**

- **Multi-stage Build**: 빌드 의존성과 런타임 의존성 분리
- **비루트 사용자**: 보안을 위해 비루트 사용자로 실행
- **레이어 캐싱**: 의존성 메타데이터를 먼저 복사하여 빌드 속도 향상
- **최소 이미지**: python:3.11-slim 기반으로 이미지 크기 최소화

## **8) 서비스 아키텍처**

### **8.1 디렉토리 구조**

```
ingest-repo/
├── app/
│   ├── __init__.py
│   ├── config.py          # 애플리케이션 설정
│   ├── main.py            # FastAPI 애플리케이션 진입점
│   ├── core/              # 핵심 모듈 (설정, 데이터베이스, 미들웨어)
│   ├── models/            # SQLAlchemy 모델
│   ├── routers/           # API 라우터
│   ├── schemas/           # Pydantic 스키마
│   └── service/           # 비즈니스 로직
├── Dockerfile
├── Jenkinsfile
├── pyproject.toml
├── uv.lock
├── run.py                 # 서버 실행 스크립트
└── .env                   # 환경 변수 (로컬 개발용)
```

### **8.2 API 엔드포인트**

- `/health` - 헬스체크
- `/docs` - Swagger UI
- `/redoc` - ReDoc 문서
- `/openapi.json` - OpenAPI 스키마

## **9) 트러블슈팅**

### **9.1 일반적인 문제**

**문제: uv.lock 업데이트 실패**

```bash
# 해결: Docker 컨테이너에서 실행
docker run --rm -v "$PWD":/app -w /app python:3.11-slim bash -c "
    apt-get update && apt-get install -y curl ca-certificates && \
    curl -fsSL https://astral.sh/uv/install.sh | sh && \
    /root/.local/bin/uv lock
"
```

**문제: 데이터베이스 연결 실패**

```bash
# 확인: 네트워크 연결 상태
docker network inspect db-network
# 확인: 환경 변수
docker exec hebees-ingest env | grep DB_
```

**문제: Redis 연결 실패**

```bash
# 확인: Redis 서버 상태
docker exec database-redis redis-cli ping
# 확인: 환경 변수
docker exec hebees-ingest env | grep REDIS_
```

### **9.2 로그 확인**

```bash
# 컨테이너 로그 확인
docker logs hebees-ingest
# 실시간 로그 스트리밍
docker logs -f hebees-ingest
# 최근 100줄 로그
docker logs --tail 100 hebees-ingest
```

### **9.3 헬스체크**

```bash
# 컨테이너 내부에서 헬스체크
docker exec hebees-ingest curl http://localhost:8000/health
# 외부에서 헬스체크 (포트 포워딩 시)
curl http://localhost:8000/health
```

## **10) 운영 및 모니터링**

### **10.1 로그 관리**

- **로그 레벨**: LOGGING_LEVEL 환경 변수로 조절 (DEBUG, INFO, WARNING, ERROR)
- **로그 파일**: LOG_FILE_ENABLED=true 시 파일 로깅 활성화
- **로그 로테이션**: LOG_FILE_MAX_BYTES 및 LOG_FILE_BACKUP_COUNT 설정

### **10.2 성능 모니터링**

- **메트릭 수집**: FastAPI /metrics 엔드포인트 (구현 필요)
- **헬스체크**: /health 엔드포인트로 서비스 상태 확인
- **리소스 모니터링**: Docker stats 명령어 활용

```bash
# 컨테이너 리소스 사용량 확인
docker stats hebees-ingest
```

### **10.3 백업 및 복구**

- **데이터베이스**: MySQL 백업 절차 준수
- **설정 파일**: .env 파일 및 Docker 설정 버전 관리
- **이미지**: Docker 이미지 레지스트리에 백업

## **11) 보안 권장사항**

1. **환경 변수 관리**: 민감한 정보는 .env 파일에 저장하고 .gitignore에 추가
2. **네트워크 격리**: Docker 네트워크를 활용한 서비스 간 격리
3. **비루트 사용자**: 컨테이너 실행 시 비루트 사용자 사용
4. **HTTPS**: 프로덕션 환경에서는 HTTPS 필수
5. **CORS**: ALLOWED_ORIGINS 설정으로 허용된 도메인만 접근 가능

## **12) 업데이트 및 유지보수**

### **12.1 의존성 업데이트**

```bash
# uv를 이용한 의존성 업데이트
uv lock --upgrade
# 특정 패키지 업데이트
uv add <package>@latest
```

### **12.2 롤백 절차**

```bash
# 이전 버전 이미지로 롤백
docker stop hebees-ingest
docker rm hebees-ingest
docker run -d --name hebees-ingest ... hebees/ingest:${PREVIOUS_BUILD_NUMBER}
```

### **12.3 버전 관리**

- Git 태그를 활용한 릴리스 버전 관리
- Docker 이미지 태그로 버전 추적
- CHANGELOG.md 유지

---

# HEBEES Query Embedding 포팅(배포) 매뉴얼 v1.0

> 대상: 운영/개발 환경에 Query Embedding 서비스(FastAPI)를 설치·구동·운영하려는 엔지니어
> 

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Embedding Models**:
    - E5-Large (sentence-transformers)
    - mCLIP (multilingual CLIP)
- **ML Libraries**:
    - PyTorch 2.0.0+
    - sentence-transformers 2.2.0+
    - numpy 1.24.0+
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **Cache**: Redis 5.0.0+
- **HTTP Client**: HTTPX 0.28.1 (서비스 간 통신)
- **Logging**: loguru 0.7.0+
- **Docs**: FastAPI 자체 Swagger UI
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv
- **의존성 관리**: pyproject.toml + uv.lock

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.
> 

### 주요 디렉터리 구조

```
query-embedding-repo/
├── app/
│   ├── config.py                    # 환경 설정
│   ├── main.py                      # FastAPI 애플리케이션 엔트리포인트
│   ├── core/                        # 핵심 컴포넌트
│   │   ├── database.py              # 데이터베이스 연결
│   │   ├── openapi.py               # OpenAPI 설정
│   │   └── settings.py              # 설정 관리
│   ├── middleware/                  # 미들웨어
│   │   └── metrics_middleware.py   # 메트릭 수집
│   ├── models/                      # 데이터 모델
│   │   └── runpod.py               # RunPod 관련 모델
│   ├── routers/                     # API 라우터
│   │   └── router.py               # 라우팅 정의
│   ├── schemas/                     # Request/Response 스키마
│   │   ├── request/
│   │   │   └── queryEmbeddingRequest.py
│   │   └── response/
│   │       ├── errorResponse.py
│   │       └── queryEmbeddingProcessResponse.py
│   ├── services/                    # 비즈니스 로직
│   │   ├── embedding_client.py     # 임베딩 클라이언트
│   │   └── runpod_service.py       # RunPod 통신
│   └── src/                         # 임베딩 모델 구현
│       ├── base.py                  # 기본 임베딩 인터페이스
│       ├── e5Large.py               # E5-Large 모델
│       └── mclip.py                 # mCLIP 모델
├── pyproject.toml                   # 프로젝트 메타데이터 및 의존성
├── uv.lock                          # 의존성 잠금 파일
├── Dockerfile                       # Docker 이미지 빌드 설정
├── run.py                           # 애플리케이션 실행 스크립트
└── README.md                        # 프로젝트 문서
```

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.
> 

### **3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서버 이름 | HEBEES Query Embedding Service |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

### **3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,http://localhost:3000,https://www.ragextension.shop,https://dev.ragextension.shop |

### **3.3 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/query-embedding.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

### **3.4 환경 설정**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ENVIRONMENT | 환경 이름 | production |
| DEBUG | 디버그 모드 | false |

### **3.5 외부 서비스 (선택사항)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| RUNPOD_API_KEY | RunPod API Key (모니터링용) | rpa_… |

## **4) 로컬 개발 절차**

### **4.1 사전 준비물**

- Python 3.11+
- uv (Python 패키지 관리자)
- 충분한 메모리 (최소 4GB, 권장 8GB 이상) - 임베딩 모델 로딩용

### **4.2 환경 변수 파일 생성**

프로젝트 루트에 .env 파일 생성:

```bash
# 애플리케이션 설정
APP_NAME=HEBEES Query Embedding Service
HOST=0.0.0.0
PORT=8000

# CORS
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://dev.ragextension.shop,https://www.ragextension.shop

# 로깅
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false

# 환경
ENVIRONMENT=development
DEBUG=true
```

### **4.3 의존성 설치 & 실행**

```bash
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh

# 의존성 설치
uv sync --frozen --no-dev

# 개발 서버 실행
python run.py

# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### **4.4 API 문서 접근**

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- Health Check: http://localhost:8000/health

### **4.5 주요 API 엔드포인트**

- `GET /` - 서비스 상태 확인
- `GET /health` - 헬스체크
- `POST /embed/query` - 쿼리 임베딩 생성 (E5-Large 또는 mCLIP)

## **5) 배포 절차**

### **5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: hebees-query-embedding
- **네트워크**: app-network-test, app-network-prod

### **5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials)
2. Docker 이미지 빌드: `docker build -t hebees/query-embedding:${BUILD_NUMBER} .`
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행 (환경 변수 주입)
5. Health Check: `/health` 엔드포인트 확인

### **5.3 Docker 실행 명령어**

```bash
docker run -d \
  --name hebees-query-embedding \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --env APP_NAME="HEBEES Query Embedding Service" \
  --env HOST=0.0.0.0 \
  --env PORT=8000 \
  --env ALLOWED_ORIGINS="https://www.ragextension.shop,https://dev.ragextension.shop" \
  --env LOGGING_LEVEL=INFO \
  --env LOG_FILE_ENABLED=false \
  --env ENVIRONMENT=production \
  --env DEBUG=false \
  hebees/query-embedding:${BUILD_NUMBER}
```

> 중요:
- 임베딩 모델 로딩에 시간이 소요될 수 있습니다 (첫 실행 시 1-2분)
- 메모리 제한 설정 시 최소 4GB 이상 할당 권장
- 여러 네트워크에 연결하여 다른 서비스들과 통신할 수 있도록 합니다
> 

## **6) Docker 빌드 설정**

### **6.1 멀티 스테이지 빌드**

Dockerfile은 2단계 빌드를 사용하여 이미지 크기를 최적화합니다:

1. **Builder Stage**:
    - Python 3.11-slim 기반
    - uv를 사용한 의존성 설치
    - 가상환경 생성
2. **Runtime Stage**:
    - Python 3.11-slim 기반
    - 빌더에서 생성된 가상환경 복사
    - 비루트 사용자(app) 생성 및 사용
    - 애플리케이션 코드 복사

### **6.2 보안 설정**

- 비루트 사용자로 실행: `app` 사용자
- 로그 디렉터리 권한 설정: `/var/log/hebees`
- 최소 권한 원칙 적용

## **7) 모니터링 & 운영**

### **7.1 헬스체크**

```bash
# 기본 헬스체크
curl http://localhost:8000/health

# 응답 예시
{
  "status": "healthy",
  "version": "0.0.1"
}
```

### **7.2 로그 확인**

```bash
# Docker 컨테이너 로그
docker logs hebees-query-embedding

# 파일 로깅 활성화 시
docker exec hebees-query-embedding tail -f /var/log/hebees/query-embedding.log
```

### **7.3 메트릭 수집**

- 미들웨어를 통한 요청/응답 메트릭 자동 수집
- 임베딩 처리 시간 및 성능 지표 추적

### **7.4 성능 고려사항**

- **첫 요청 지연**: 모델 로딩으로 인한 초기 지연 발생 가능
- **메모리 사용량**: 임베딩 모델 로드 시 2-4GB 메모리 사용
- **동시성 처리**: Uvicorn 워커 수 조정으로 성능 최적화 가능
- **모델 캐싱**: 모델은 메모리에 로드되어 재사용됨

## **8) 트러블슈팅**

### **8.1 일반적인 문제**

**문제: 컨테이너가 시작 후 종료됨**
- 원인: 메모리 부족 또는 모델 로딩 실패
- 해결: Docker 메모리 제한 확인 및 증가 (`--memory=4g`)

**문제: 임베딩 요청이 느림**
- 원인: GPU 미사용 또는 모델 초기화 지연
- 해결: 첫 요청은 느릴 수 있음 (모델 로딩), 이후 요청은 빠름

**문제: CORS 에러**
- 원인: ALLOWED_ORIGINS 설정 불일치
- 해결: 프론트엔드 도메인을 ALLOWED_ORIGINS에 추가

### **8.2 의존성 문제**

**문제: uv sync 실패**
- 원인: Python 버전 불일치 또는 잠금 파일 손상
- 해결: Python 3.11 이상 확인, uv.lock 재생성

```bash
# uv.lock 재생성
uv lock --upgrade
```

## **9) 서비스 통합**

### **9.1 RAG Orchestrator 연동**

Query Embedding 서비스는 RAG Orchestrator와 연동되어 사용됩니다:

- RAG Orchestrator가 쿼리 임베딩 요청을 Query Embedding 서비스로 전달
- 임베딩 벡터 생성 후 응답 반환
- 동일한 Docker 네트워크 내에서 서비스명으로 통신

**연동 예시:**

```python
# RAG Orchestrator에서 호출
response = await httpx.post(
    "http://hebees-query-embedding:8000/embed/query",
    json={"query": "검색 쿼리", "model": "e5-large"}
)
```

### **9.2 네트워크 구성**

- **app-network-test**: 테스트 환경 서비스 간 통신
- **app-network-prod**: 운영 환경 서비스 간 통신

## **10) 버전 정보**

- **Current Version**: 0.0.1
- **Framework**: FastAPI 0.119.0
- **Python**: 3.11
- **Last Updated**: 2025-01-19

## **11) 참고사항**

### **11.1 임베딩 모델**

- **E5-Large**: 영어 및 다국어 텍스트 임베딩에 최적화
- **mCLIP**: 멀티모달(텍스트+이미지) 임베딩 지원

### **11.2 성능 벤치마크**

- **평균 임베딩 시간**: 50-200ms (텍스트 길이에 따라 변동)
- **최대 배치 크기**: 32개 쿼리 동시 처리
- **메모리 사용량**: 2-4GB (모델 로드 상태)

### **11.3 확장성**

- 수평 확장: 여러 인스턴스 실행 가능 (로드 밸런서 필요)
- GPU 지원: CUDA 사용 시 성능 향상 가능 (Dockerfile 수정 필요)

---

# HEBEES Search 포팅(배포) 매뉴얼 v1.0

> 대상: 운영/개발 환경에 Search Service(FastAPI)를 설치·구동·운영하려는 엔지니어
> 

---

## **1) 시스템 개요**

- **Framework**: FastAPI 0.119.0
- **Language**: Python 3.11
- **Package Manager**: uv (Python 패키지 관리자)
- **ASGI Server**: Uvicorn 0.38.0
- **Database**: MySQL (aiomysql 0.2.0, SQLAlchemy 2.0.44)
- **Vector DB**: Milvus (pymilvus ≥2.4.0, langchain-milvus ≥0.1.0)
- **Cache**: Redis (redis ≥5.0.0)
- **HTTP Client**: HTTPX 0.28.1 (서비스 간 통신)
- **Logging**: Loguru ≥0.7.0
- **Docs**: FastAPI 자체 Swagger UI
- **Deployment**: Docker + Uvicorn

## **2) 소스 구조 & 빌드 스펙**

- **Python**: 3.11 이상 (필수)
- **Package Manager**: uv
- **의존성 관리**: pyproject.toml + uv.lock

> pyproject.toml과 uv.lock의 버전을 동일하게 유지하세요. Python 3.11 미만에서는 실행이 실패할 수 있습니다.
> 

**주요 디렉터리 구조**:

```
search-repo/
├── app/
│   ├── core/          # 핵심 설정 및 OpenAPI 구성
│   ├── middleware/    # 메트릭 미들웨어
│   ├── routers/       # API 라우터
│   ├── schemas/       # 요청/응답 스키마
│   ├── service/       # 비즈니스 로직
│   ├── src/           # 검색 엔진 구현 (Base, Semantic)
│   ├── config.py      # 설정 관리
│   └── main.py        # FastAPI 애플리케이션 진입점
├── run.py             # 서버 실행 스크립트
├── Dockerfile         # Docker 이미지 빌드 파일
├── pyproject.toml     # 프로젝트 메타데이터 및 의존성
└── uv.lock            # 의존성 잠금 파일
```

## **3) 환경 변수(ENV) 정의**

> 애플리케이션은 .env 파일 또는 환경 변수로 설정을 주입받습니다.
> 

### **3.1 서버/네트워크**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| APP_NAME | 서버 이름 | HEBEES Search Service |
| HOST | 서버 호스트 | 0.0.0.0 |
| PORT | 서버 포트 | 8000 |

### **3.2 CORS**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| ALLOWED_ORIGINS | 허용된 Origin 목록 (쉼표 구분) | http://localhost:5173,http://localhost:3000,https://www.ragextension.shop |

### **3.3 MySQL**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| DB_HOST | MySQL 호스트 | database-mysql |
| DB_PORT | MySQL 포트 | 3306 |
| DB_NAME | 데이터베이스 이름 | hebees-test |
| DB_USERNAME | DB 계정 | s407test |
| DB_PASSWORD | DB 비밀번호 | q1w2e3r4 |

### **3.4 Redis**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| REDIS_HOST | Redis 호스트 | database-redis |
| REDIS_PORT | Redis 포트 | 6379 |
| REDIS_USERNAME | Redis 계정 | default |
| REDIS_PASSWORD | Redis 비밀번호 | 1q2w3e4r |
| REDIS_DB | Redis DB 인덱스 | 0 |

### **3.5 Milvus (Vector Database)**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| MILVUS_HOST | Milvus 호스트 | milvus-standalone |
| MILVUS_PORT | Milvus 포트 | 19530 |
| MILVUS_USER | Milvus 사용자 (옵션) | default |
| MILVUS_PASSWORD | Milvus 비밀번호 (옵션) | - |

### **3.6 로깅**

| 키 | 설명 | 예시 |
| --- | --- | --- |
| LOGGING_LEVEL | 로깅 레벨 | INFO (기본값) |
| LOG_FILE_ENABLED | 파일 로깅 활성화 | false (기본값) |
| LOG_FILE_PATH | 로그 파일 경로 | /var/log/hebees/search.log |
| LOG_FILE_MAX_BYTES | 로그 파일 최대 크기 | 10485760 (10MB) |
| LOG_FILE_BACKUP_COUNT | 로그 파일 백업 개수 | 5 |

## **4) 로컬 개발 절차**

### **4.1 사전 준비물**

- Python 3.11+
- uv (Python 패키지 관리자)
- MySQL 8.x
- Redis
- Milvus

### **4.2 환경 변수 주입(.env 예시)**

프로젝트 루트에 `.env` 파일 생성:

```bash
# 애플리케이션 설정
APP_NAME=HEBEES Search Service
HOST=0.0.0.0
PORT=8000

# CORS
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://www.ragextension.shop,https://dev.ragextension.shop

# MySQL 설정
DB_HOST=localhost
DB_PORT=13306
DB_NAME=hebees-test
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4

# Redis 설정
REDIS_HOST=localhost
REDIS_PORT=16379
REDIS_PASSWORD=1q2w3e4r
REDIS_DB=0

# Milvus 설정
MILVUS_HOST=localhost
MILVUS_PORT=19530

# 로깅
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
```

### **4.3 의존성 설치 & 실행**

```bash
# uv 설치 (없는 경우)
curl -fsSL https://astral.sh/uv/install.sh | sh

# 의존성 설치
uv sync --frozen --no-dev

# 개발 서버 실행
python run.py

# 또는 uvicorn 직접 실행
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

### **4.4 API 문서 접근**

- Swagger UI: http://localhost:8000/docs
- ReDoc: http://localhost:8000/redoc
- Health Check: http://localhost:8000/health

## **5) 배포 절차**

### **5.1 배포 전략**

프로젝트는 단일 컨테이너 배포를 사용합니다:

- **컨테이너명**: hebees-search
- **네트워크**: app-network-test, app-network-prod, db-network

### **5.2 배포 단계**

1. 환경 변수 파일 준비 (.env 또는 Jenkins credentials)
2. Docker 이미지 빌드: `docker build -t hebees/search:${BUILD_NUMBER} .`
3. 기존 컨테이너 중지 및 삭제
4. 새 컨테이너 실행 (환경 변수 주입)
5. Health Check: `/health` 엔드포인트 확인

### **5.3 Docker 실행 명령어**

```bash
docker run -d \
  --name hebees-search \
  --restart unless-stopped \
  --network app-network-test \
  --network app-network-prod \
  --network db-network \
  --env-file .env \
  hebees/search:${BUILD_NUMBER}
```

> 중요: 여러 네트워크에 연결하여 다른 서비스들과 통신할 수 있도록 합니다.
> 

### **5.4 환경별 배포 설정**

### Test 환경

```bash
docker run -d \
  --name hebees-search-test \
  --restart unless-stopped \
  --network app-network-test \
  --network db-network \
  --env APP_NAME="HEBEES Search Service (Test)" \
  --env HOST=0.0.0.0 \
  --env PORT=8000 \
  --env ALLOWED_ORIGINS="https://dev.ragextension.shop" \
  --env DB_HOST=database-mysql \
  --env DB_PORT=3306 \
  --env DB_NAME=hebees-test \
  --env DB_USERNAME=${DB_USERNAME} \
  --env DB_PASSWORD=${DB_PASSWORD} \
  --env REDIS_HOST=database-redis \
  --env REDIS_PORT=6379 \
  --env REDIS_PASSWORD=${REDIS_PASSWORD} \
  --env REDIS_DB=0 \
  --env MILVUS_HOST=milvus-standalone \
  --env MILVUS_PORT=19530 \
  --env LOGGING_LEVEL=DEBUG \
  hebees/search:${BUILD_NUMBER}
```

### Production 환경

```bash
docker run -d \
  --name hebees-search-prod \
  --restart unless-stopped \
  --network app-network-prod \
  --network db-network \
  --env APP_NAME="HEBEES Search Service" \
  --env HOST=0.0.0.0 \
  --env PORT=8000 \
  --env ALLOWED_ORIGINS="https://www.ragextension.shop" \
  --env DB_HOST=database-mysql \
  --env DB_PORT=3306 \
  --env DB_NAME=hebees-prod \
  --env DB_USERNAME=${DB_USERNAME} \
  --env DB_PASSWORD=${DB_PASSWORD} \
  --env REDIS_HOST=database-redis \
  --env REDIS_PORT=6379 \
  --env REDIS_PASSWORD=${REDIS_PASSWORD} \
  --env REDIS_DB=0 \
  --env MILVUS_HOST=milvus-standalone \
  --env MILVUS_PORT=19530 \
  --env LOGGING_LEVEL=INFO \
  hebees/search:${BUILD_NUMBER}
```

## **6) 주요 API 엔드포인트**

### **6.1 Health Check**

- **GET** `/health` - 서비스 상태 확인

### **6.2 검색 API**

- **POST** `/search/process` - 검색 요청 처리
    - Request Body: `SearchRequest` 스키마
    - Response: `SearchProcessResponse` 스키마

### **6.3 메트릭**

- **GET** `/metrics` - 검색 성능 메트릭 조회 (미들웨어를 통한 자동 수집)

## **7) 핵심 기능**

### **7.1 검색 엔진**

- **Base Search**: 기본 검색 기능 제공
- **Semantic Search**: 벡터 기반 의미론적 검색 (Milvus 연동)

### **7.2 메트릭 수집**

- 요청/응답 시간 추적
- 검색 성능 모니터링
- 미들웨어 기반 자동 수집

### **7.3 캐싱**

- Redis를 통한 검색 결과 캐싱
- 성능 최적화 및 응답 시간 단축

## **8) 모니터링 및 로깅**

### **8.1 로그 설정**

- Loguru 기반 구조화된 로깅
- 파일 로깅 옵션 (LOG_FILE_ENABLED=true)
- 로그 레벨: DEBUG, INFO, WARNING, ERROR, CRITICAL

### **8.2 Health Check**

```bash
curl http://localhost:8000/health
# Expected Response:
# {
#   "status": "healthy",
#   "version": "0.0.1"
# }
```

### **8.3 메트릭 모니터링**

- 검색 요청 처리 시간
- 캐시 히트율
- 벡터 검색 성능

## **9) 문제 해결 (Troubleshooting)**

### **9.1 Milvus 연결 실패**

- Milvus 서비스가 실행 중인지 확인
- 네트워크 연결 확인: `docker network inspect db-network`
- MILVUS_HOST, MILVUS_PORT 환경 변수 확인

### **9.2 Redis 연결 실패**

- Redis 서비스 상태 확인
- REDIS_PASSWORD 일치 여부 확인
- Redis DB 인덱스 확인

### **9.3 MySQL 연결 실패**

- DB_HOST, DB_PORT, DB_NAME 확인
- DB_USERNAME, DB_PASSWORD 자격 증명 확인
- 데이터베이스 존재 여부 확인

### **9.4 메모리 부족**

- Docker 컨테이너 메모리 제한 증가
- Milvus 벡터 검색 배치 크기 조정
- 캐시 TTL 조정으로 메모리 사용량 최적화

## **10) 보안 고려사항**

### **10.1 환경 변수 관리**

- 민감한 정보(DB 비밀번호, API 키)는 환경 변수로 주입
- `.env` 파일은 절대 버전 관리 시스템에 커밋하지 않음
- Jenkins credentials 또는 secrets manager 사용 권장

### **10.2 네트워크 보안**

- Docker 네트워크 격리
- CORS 설정으로 허용된 Origin만 접근 가능
- 프로덕션 환경에서는 HTTPS 필수

### **10.3 컨테이너 보안**

- 비루트 사용자로 실행 (Dockerfile에서 app 사용자 생성)
- 최소 권한 원칙 적용
- 정기적인 의존성 업데이트

## **11) 성능 최적화**

### **11.1 캐싱 전략**

- Redis 캐시 활용으로 반복 검색 최적화
- 캐시 TTL 조정으로 메모리와 신선도 균형

### **11.2 벡터 검색 최적화**

- Milvus 인덱스 타입 선택 (IVF_FLAT, HNSW 등)
- 검색 파라미터 튜닝 (nprobe, ef 등)
- 배치 검색 활용

### **11.3 연결 풀 관리**

- SQLAlchemy 연결 풀 크기 조정
- Redis 연결 풀 최적화
- 비동기 I/O 활용 (aiomysql, aioredis)

## **12) 버전 관리 및 업데이트**

### **12.1 버전 관리**

- 시맨틱 버저닝 (Semantic Versioning) 사용
- pyproject.toml의 version 필드 업데이트

### **12.2 의존성 업데이트**

```bash
# 의존성 업데이트
uv lock --upgrade

# 특정 패키지 업데이트
uv add "fastapi==0.120.0"

# 동기화
uv sync --frozen --no-dev
```

### **12.3 마이그레이션**

- 데이터베이스 스키마 변경 시 마이그레이션 스크립트 작성
- 롤백 계획 수립
- 테스트 환경에서 먼저 검증

---

## **부록: 환경 변수 전체 예시**

```bash
# 애플리케이션 설정
APP_NAME=HEBEES Search Service
HOST=0.0.0.0
PORT=8000

# CORS
ALLOWED_ORIGINS=http://localhost:5173,http://localhost:3000,https://www.ragextension.shop,https://dev.ragextension.shop

# MySQL 설정
DB_HOST=database-mysql
DB_PORT=3306
DB_NAME=hebees-test
DB_USERNAME=s407test
DB_PASSWORD=q1w2e3r4

# Redis 설정
REDIS_HOST=database-redis
REDIS_PORT=6379
REDIS_USERNAME=default
REDIS_PASSWORD=1q2w3e4r
REDIS_DB=0

# Milvus 설정
MILVUS_HOST=milvus-standalone
MILVUS_PORT=19530

# 로깅
LOGGING_LEVEL=INFO
LOG_FILE_ENABLED=false
LOG_FILE_PATH=/var/log/hebees/search.log
LOG_FILE_MAX_BYTES=10485760
LOG_FILE_BACKUP_COUNT=5
```

---